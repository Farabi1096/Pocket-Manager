<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Smooth scrolling for iOS */
        .scroll-smooth { -webkit-overflow-scrolling: touch; }

        /* Animations */
        @keyframes pageEnter { from { opacity: 0; transform: scale(0.99) translateY(5px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes staggerIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .animate-page-enter { animation: pageEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-slide-up-fade { animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) backwards; }
        .animate-stagger-in { animation: staggerIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-scale-in { animation: scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) backwards; }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) backwards; }
    </style>
</head>
<body class="bg-gray-100 h-screen w-full flex justify-center items-center overflow-hidden">

    <div id="root" class="w-full h-full max-w-md mx-auto relative shadow-2xl bg-gray-50"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useCallback } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Wallet, PieChart, Home, Settings, Plus, ArrowUpRight, ArrowDownLeft, 
            ShoppingBag, Coffee, Car, Zap, Gamepad2, Search, Bell, MoreHorizontal, 
            ChevronLeft, ChevronRight, Moon, Sun, X, Check, CreditCard, Banknote, 
            Image as ImageIcon, FileText, PiggyBank, ArrowRightLeft, HandCoins, 
            Target, Sparkles, TrendingDown, TrendingUp, AlertCircle, Loader2, 
            User, Calendar, Trophy, Repeat, Plane, Smartphone, Gift, Trash2, 
            Landmark, BellRing, Clock, Info, Briefcase, Building, MapPin, Mail, 
            Phone, ChevronDown, PlusCircle, Edit2, Heart
        } from 'https://esm.sh/lucide-react@0.344.0';

        // --- API Configuration ---
        const apiKey = ""; 

        // --- Color Palette ---
        const theme = {
          navy: '#052065',
          royalBlue: '#0060E5',
          skyBlue: '#00B2FF',
          paleBlue: '#86DEF7',
          darkGreen: '#008848',
          teal: '#00B991',
          aqua: '#00DCC6',
          mint: '#A3E7D5',
          darkPurple: '#7500A7',
          purple: '#983EBD',
          lavender: '#CD9ED1',
          palePurple: '#E3C2E8',
          hotPink: '#FC0075',
          pink: '#FF81C6',
          lightPink: '#FFADD8',
          palePink: '#FFCCEB',
          red: '#F33131',
          salmon: '#FF5D55',
          lightRed: '#FF8984',
          paleRed: '#FFAAAA',
          amber: '#FFA000',
          yellow: '#FFCA05',
          brightYellow: '#FFEB00',
          paleYellow: '#FFF3A7',
        };

        const getRandomThemeColor = () => {
            const colors = Object.values(theme);
            return colors[Math.floor(Math.random() * colors.length)];
        };

        // --- Icon Mapping ---
        const ICON_MAP = {
          ShoppingBag, Wallet, Car, Gamepad2, Coffee, Zap, Smartphone, Plane, Target, Repeat, Briefcase, Gift, Home, User, ArrowRightLeft, Heart
        };

        // Helper to map category names to icon strings
        const getCategoryIcon = (category) => {
          const map = {
            'Food': 'Coffee',
            'Transport': 'Car',
            'Shopping': 'ShoppingBag',
            'Bills': 'Zap',
            'Entertainment': 'Gamepad2',
            'Health': 'Heart', 
            'Income': 'Wallet',
            'Transfer': 'ArrowRightLeft',
            'Other': 'MoreHorizontal'
          };
          return map[category] || 'ShoppingBag';
        };

        const getIcon = (iconName) => {
          return ICON_MAP[iconName] || MoreHorizontal;
        };

        // --- Helpers ---
        const formatDateToISO = (date) => {
          if (!date) return new Date().toISOString().split('T')[0];
          const offset = date.getTimezoneOffset();
          const dateLocal = new Date(date.getTime() - (offset*60*1000));
          return dateLocal.toISOString().split('T')[0];
        };

        const getRelativeDate = (daysAgo) => {
          const d = new Date();
          d.setDate(d.getDate() - daysAgo);
          return formatDateToISO(d);
        };

        const parseDate = (dateStr) => {
          const today = new Date();
          if (dateStr === 'Today' || dateStr === 'Just now') return today;
          if (dateStr === 'Yesterday') {
            const d = new Date(today);
            d.setDate(d.getDate() - 1);
            return d;
          }
          
          if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
          }

          return new Date(`${dateStr}, ${today.getFullYear()}`);
        };

        const formatDisplayDate = (dateStr) => {
          if (!dateStr) return '';
          const date = parseDate(dateStr);
          if (isNaN(date.getTime())) return dateStr;

          const today = new Date();
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);

          if (date.toDateString() === today.toDateString()) return 'Today';
          if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
          
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };

        const getCycleRange = (currentViewDate, startDay) => {
          const year = currentViewDate.getFullYear();
          const month = currentViewDate.getMonth();
          
          let start = new Date(year, month - 1, startDay);
          if (start.getMonth() !== (month - 1 + 12) % 12) {
            start = new Date(year, month, 0); 
          }

          let end = new Date(year, month, startDay - 1);
          if (end.getMonth() !== month) {
              end = new Date(year, month + 1, 0);
          }
          
          end.setHours(23, 59, 59, 999);
          return { start, end };
        };

        const getDaysUntil = (dateStr) => {
          const target = parseDate(dateStr);
          const today = new Date();
          today.setHours(0,0,0,0);
          target.setHours(0,0,0,0);
          const diffTime = target - today;
          return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        const getGreeting = () => {
            const hour = new Date().getHours();
            if (hour < 12) return "Good Morning";
            if (hour < 18) return "Good Afternoon";
            return "Good Evening";
        };

        // --- Initial Data ---
        const initialTransactionsData = [];
        const initialLoansData = [];
        const initialGoalsData = [];
        const initialSubsData = [];

        const getInitialWallets = () => {
            try {
                const saved = localStorage.getItem('wallets');
                if (saved) return JSON.parse(saved);
                const oldDetails = JSON.parse(localStorage.getItem('walletDetails')) || {};
                return [
                    { id: 'Cash', name: 'Cash Wallet', type: 'Cash', color: theme.teal, details: oldDetails['Cash'] || {}, isDefault: true },
                    { id: 'Bank', name: 'Main Bank', type: 'Bank', color: theme.royalBlue, details: oldDetails['Bank'] || {}, isDefault: true },
                    { id: 'Card', name: 'Credit Card', type: 'Card', color: theme.hotPink, details: oldDetails['Card'] || {}, isDefault: true }
                ];
            } catch {
                return [
                    { id: 'Cash', name: 'Cash Wallet', type: 'Cash', color: theme.teal, details: {}, isDefault: true },
                    { id: 'Bank', name: 'Main Bank', type: 'Bank', color: theme.royalBlue, details: {}, isDefault: true },
                    { id: 'Card', name: 'Credit Card', type: 'Card', color: theme.hotPink, details: {}, isDefault: true }
                ];
            }
        };

        // --- Components ---

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                if (!message) return;
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [message, onClose]);

            if (!message) return null;

            const bgClass = type === 'success' ? 'bg-green-500' : (type === 'info' ? 'bg-blue-500' : 'bg-red-500');
            const Icon = type === 'success' ? Check : (type === 'info' ? Info : AlertCircle);

            return (
                <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] flex items-center gap-2 px-4 py-3 rounded-xl shadow-xl text-white animate-fade-in ${bgClass}`}>
                    <Icon size={18} />
                    <span className="text-sm font-bold">{message}</span>
                </div>
            );
        };

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message, isDarkMode }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={onClose}></div>
                    <div className={`relative w-full max-w-sm p-6 rounded-2xl shadow-2xl transform transition-all scale-100 ${isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'}`}>
                        <h3 className="text-lg font-bold mb-2">{title}</h3>
                        <p className={`text-sm mb-6 ${isDarkMode ? 'text-gray-300' : 'text-gray-500'}`}>{message}</p>
                        <div className="flex gap-3">
                            <button onClick={onClose} className={`flex-1 py-2.5 rounded-xl font-bold text-sm transition-colors ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}>Cancel</button>
                            <button onClick={() => { onConfirm(); onClose(); }} className="flex-1 py-2.5 rounded-xl font-bold text-sm bg-red-500 text-white hover:bg-red-600 shadow-md shadow-red-500/20">Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };

        const WelcomeModal = ({ onSave, isDarkMode }) => {
            const [name, setName] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (name.trim()) onSave(name);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/60 backdrop-blur-md">
                    <div className={`w-full max-w-sm p-8 rounded-3xl shadow-2xl transform transition-all scale-100 ${isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900'}`}>
                        <div className="flex justify-center mb-6">
                            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                                <User size={32} className="text-blue-600" />
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-center mb-2">Welcome!</h2>
                        <p className="text-center text-sm opacity-60 mb-8">Let's get to know each other. What should we call you?</p>
                        <form onSubmit={handleSubmit}>
                            <input 
                                type="text" 
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="Enter your name" 
                                className={`w-full p-4 rounded-xl text-center text-lg font-bold outline-none border-2 mb-4 transition-all ${isDarkMode ? 'bg-gray-700 border-gray-600 focus:border-blue-500' : 'bg-gray-50 border-gray-100 focus:border-blue-500'}`}
                                autoFocus
                            />
                            <button 
                                type="submit" 
                                disabled={!name.trim()}
                                className="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                            >
                                Get Started
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const NotificationSidebar = ({ notifications, isOpen, onClose, isDarkMode }) => {
          return (
            <>
              {/* Backdrop */}
              <div 
                className={`fixed inset-0 z-[60] bg-black/20 backdrop-blur-sm transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} 
                onClick={onClose}
              />
              
              {/* Sidebar sliding from RIGHT - Glass/Blur Effect - Fixed Width */}
              <div 
                className={`fixed inset-y-0 right-0 z-[70] w-80 shadow-2xl transform transition-transform duration-300 ease-[cubic-bezier(0.32,0.72,0,1)] ${isOpen ? 'translate-x-0' : 'translate-x-full'} ${isDarkMode ? 'bg-gray-900/90 border-l border-gray-800' : 'bg-white/90 border-l border-gray-100'} backdrop-blur-xl`}
              >
                <div className="flex flex-col h-full">
                  {/* Header with Mobile Safe Area Padding (pt-16) */}
                  <div className={`flex justify-between items-end px-6 pb-6 pt-16 border-b shrink-0 ${isDarkMode ? 'border-gray-800' : 'border-gray-100'}`}>
                    <div className="flex items-center gap-3">
                      <h3 className={`font-bold text-2xl tracking-tight ${isDarkMode ? 'text-white' : 'text-[#052065]'}`}>Notifications</h3>
                      {notifications.length > 0 && (
                          <span className="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm animate-pulse">
                              {notifications.length}
                          </span>
                      )}
                    </div>
                    <button onClick={onClose} className={`p-2 rounded-full transition-colors active:scale-95 ${isDarkMode ? 'bg-gray-800 hover:bg-gray-700 text-gray-300' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}>
                        <X size={24} />
                    </button>
                  </div>
                  
                  {/* Scrollable List */}
                  <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                    {notifications.length === 0 ? (
                      <div className="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
                        <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 ${isDarkMode ? 'bg-gray-800' : 'bg-gray-50'}`}>
                            <BellRing size={32} className="opacity-30" />
                        </div>
                        <p className="text-sm font-medium">All caught up!</p>
                      </div>
                    ) : (
                      notifications.map((notif, idx) => (
                        <div key={idx} className={`p-4 rounded-[1.25rem] flex items-start gap-4 transition-all duration-200 ${isDarkMode ? 'bg-gray-800/60 border border-gray-700/50 hover:bg-gray-800' : 'bg-white border border-gray-100 shadow-sm hover:shadow-md'}`}>
                          <div className={`p-3 rounded-2xl shrink-0 ${notif.type === 'alert' ? 'bg-red-500/10 text-red-500' : 'bg-blue-500/10 text-blue-500'}`}>
                            {notif.type === 'alert' ? <AlertCircle size={20} /> : <Clock size={20} />}
                          </div>
                          <div>
                            <h4 className={`text-sm font-bold mb-1 leading-tight ${isDarkMode ? 'text-gray-100' : 'text-gray-800'}`}>{notif.title}</h4>
                            <p className={`text-xs leading-relaxed ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>{notif.message}</p>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                  
                  {/* Footer Action */}
                  <div className={`p-6 border-t shrink-0 ${isDarkMode ? 'border-gray-800' : 'border-gray-100'}`}>
                    <button onClick={onClose} className={`w-full py-4 rounded-2xl text-sm font-bold transition-all active:scale-[0.98] shadow-lg ${isDarkMode ? 'bg-gray-800 text-white hover:bg-gray-700' : 'bg-[#052065] text-white hover:opacity-90'}`}>
                      Mark all as read
                    </button>
                  </div>
                </div>
              </div>
            </>
          );
        };

        const Header = React.memo(({ isDarkMode, setIsDarkMode, isSearchOpen, setIsSearchOpen, searchQuery, setSearchQuery, notifications, isNotifOpen, setIsNotifOpen, activeTab, userName }) => {
          
          const getHeaderContent = () => {
              if (activeTab === 'home') {
                  return (
                    <div>
                      <h2 className={`text-sm font-medium transition-colors ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>{getGreeting()},</h2>
                      <h1 className="text-2xl font-bold tracking-tight">{userName || 'User'}</h1>
                    </div>
                  );
              }
              
              const titles = {
                  'wallet': 'My Wallets',
                  'loans': 'Loan Manager',
                  'goals': 'Financial Goals',
                  'subs': 'Subscriptions',
                  'stats': 'Statistics',
                  'suggestions': 'AI Insights',
                  'profile': 'Settings'
              };
              return <h1 className="text-2xl font-bold tracking-tight">{titles[activeTab] || 'Finance Tracker'}</h1>;
          };

          return (
            <div 
                // Increased top padding (pt-16) for mobile safe area, normalized (md:py-6) for desktop
                className={`sticky top-0 z-50 flex justify-between items-center px-6 pt-16 pb-4 md:py-6 animate-fade-in transition-all duration-300 backdrop-blur-xl ${isDarkMode ? 'bg-gray-900/85 supports-[backdrop-filter]:bg-gray-900/60' : 'bg-gray-50/85 supports-[backdrop-filter]:bg-gray-50/60'}`} 
                style={{ color: isDarkMode ? 'white' : theme.navy }}
            >
                <div className="flex-1 mr-4">
                {isSearchOpen && activeTab === 'home' ? (
                    <div className={`flex items-center rounded-xl px-3 py-2 transition-colors ${isDarkMode ? 'bg-gray-800' : 'bg-white shadow-sm'}`}>
                    <Search size={18} className="mr-2 opacity-50" />
                    <input 
                        type="text" 
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Search..."
                        className="bg-transparent w-full outline-none text-sm font-medium"
                        autoFocus
                    />
                    {searchQuery && (
                        <button onClick={() => setSearchQuery('')} className="ml-2">
                        <X size={16} className="opacity-50" />
                        </button>
                    )}
                    </div>
                ) : getHeaderContent()}
                </div>
                <div className="flex gap-3 relative">
                    
                {activeTab === 'home' && (
                    <>
                        <button 
                            onClick={() => {
                                setIsSearchOpen(!isSearchOpen);
                                if (isSearchOpen) setSearchQuery(''); 
                            }}
                            className={`p-2 rounded-full transition-all active:scale-95 ${isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-200 shadow-sm'} ${isSearchOpen ? 'bg-blue-100 text-blue-600' : ''}`}
                        >
                            {isSearchOpen ? <X size={20} /> : <Search size={20} color={isDarkMode ? 'white' : theme.navy} />}
                        </button>
                        
                        <button 
                            onClick={() => setIsDarkMode(!isDarkMode)}
                            className={`p-2 rounded-full transition-all active:scale-95 ${isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-200 shadow-sm'}`}
                        >
                            {isDarkMode ? (
                            <Sun size={20} className="text-white" />
                            ) : (
                            <Moon size={20} color={theme.navy} />
                            )}
                        </button>
                    </>
                )}

                <button 
                    onClick={() => setIsNotifOpen(true)}
                    className={`p-2 rounded-full relative transition-all active:scale-95 ${isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white hover:bg-gray-200 shadow-sm'}`}
                >
                    <Bell size={20} color={isDarkMode ? 'white' : theme.navy} />
                    {notifications.length > 0 && (
                    <span className="absolute top-2 right-2 w-2.5 h-2.5 rounded-full border-2 border-white bg-red-500 shadow-sm animate-pulse"></span>
                    )}
                </button>
                
                <NotificationSidebar 
                    notifications={notifications} 
                    isOpen={isNotifOpen} 
                    onClose={() => setIsNotifOpen(false)} 
                    isDarkMode={isDarkMode} 
                />
                </div>
            </div>
          );
        });

        const MonthSelector = React.memo(({ date, salaryDate, onPrev, onNext, isDarkMode }) => {
          const { start, end } = getCycleRange(date, salaryDate);
          const rangeString = `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;

          return (
            <div className="flex items-center justify-between px-6 py-2 mb-2 animate-fade-in">
              <button 
                onClick={onPrev} 
                className={`p-2 rounded-full active:scale-95 transition-all ${isDarkMode ? 'text-gray-400 hover:bg-gray-800 hover:text-white' : 'text-gray-400 hover:bg-gray-100 hover:text-gray-600'}`}
              >
                <ChevronLeft size={24} />
              </button>
              
              <div className="flex flex-col items-center">
                <span className="text-lg font-bold min-w-[140px] text-center transition-colors duration-300 tracking-tight" style={{ color: isDarkMode ? 'white' : theme.navy }}>
                  {date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                </span>
                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                  {rangeString}
                </span>
              </div>

              <button 
                onClick={onNext} 
                className={`p-2 rounded-full active:scale-95 transition-all ${isDarkMode ? 'text-gray-400 hover:bg-gray-800 hover:text-white' : 'text-gray-400 hover:bg-gray-100 hover:text-gray-600'}`}
              >
                <ChevronRight size={24} />
              </button>
            </div>
          );
        });

        const BalanceCard = React.memo(({ totalBalance, income, expense, isDarkMode }) => {
          const savings = income + expense; 

          return (
            <div className="mx-6 mt-4 p-6 rounded-[2rem] text-white shadow-xl relative overflow-hidden animate-slide-up-fade"
               style={{ background: `linear-gradient(135deg, ${theme.navy} 0%, ${theme.royalBlue} 100%)` }}>
              <div className="relative z-10">
                <p className="opacity-80 text-sm font-medium mb-1 tracking-wide">Total Balance</p>
                <h2 className="text-4xl font-bold mb-8 tracking-tight">${totalBalance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</h2>
                <div className="flex gap-4">
                  <div className="flex-1">
                    <div className="flex items-center gap-1.5 mb-1 opacity-80"><div className="p-1 rounded-full bg-white/20"><ArrowDownLeft size={10} className="text-white" /></div><span className="text-[10px] font-bold uppercase tracking-wider">Income</span></div>
                    <p className="font-bold text-lg tracking-tight truncate">${income.toLocaleString()}</p>
                  </div>
                  <div className="flex-1 border-l border-white/10 pl-4">
                    <div className="flex items-center gap-1.5 mb-1 opacity-80"><div className="p-1 rounded-full bg-white/20"><ArrowUpRight size={10} className="text-white" /></div><span className="text-[10px] font-bold uppercase tracking-wider">Expense</span></div>
                    <p className="font-bold text-lg tracking-tight truncate">${Math.abs(expense).toLocaleString()}</p>
                  </div>
                  <div className="flex-1 border-l border-white/10 pl-4">
                    <div className="flex items-center gap-1.5 mb-1 opacity-80"><div className="p-1 rounded-full bg-white/20"><PiggyBank size={10} className="text-white" /></div><span className="text-[10px] font-bold uppercase tracking-wider">Savings</span></div>
                    <p className="font-bold text-lg tracking-tight truncate">${savings.toLocaleString()}</p>
                  </div>
                </div>
              </div>
            </div>
          );
        });

        const WalletCard = React.memo(({ wallet, isDarkMode, onClick, onDelete }) => {
          const Icon = wallet.type === 'Bank' ? Landmark : (wallet.type === 'Cash' ? Banknote : CreditCard);
          
          return (
            <div 
              onClick={onClick}
              className="relative overflow-hidden p-6 rounded-[2rem] text-white shadow-lg transition-transform hover:scale-[1.02] cursor-pointer mb-4 group"
              style={{ background: wallet.color || theme.royalBlue }}
            >
              <div className="absolute top-[-20px] right-[-20px] w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
              <div className="absolute bottom-[-20px] left-[-20px] w-24 h-24 bg-black/10 rounded-full blur-xl"></div>
              
              <div className="relative z-10 flex flex-col h-full justify-between min-h-[120px]">
                <div className="flex justify-between items-start">
                  <div className="p-2.5 bg-white/20 rounded-xl backdrop-blur-sm">
                    <Icon size={24} className="text-white" />
                  </div>
                  {wallet.details?.accountNumber && <span className="font-mono opacity-80 text-sm tracking-widest">•••• {wallet.details.accountNumber.slice(-4)}</span>}
                </div>
                
                <div className="mt-4">
                  <p className="opacity-80 text-xs font-bold uppercase tracking-wider mb-1 flex items-center gap-1">
                     {wallet.name} {wallet.isDefault && <span className="bg-white/20 px-1.5 rounded text-[8px]">Default</span>}
                  </p>
                  <h3 className="text-2xl font-bold tracking-tight">${wallet.balance?.toLocaleString() || '0'}</h3>
                </div>
              </div>
              
              <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                  <div className="bg-white/20 p-1.5 rounded-full"><Edit2 size={14} /></div>
              </div>
            </div>
          );
        });

        const QuickActions = React.memo(({ isDarkMode, onNavigate }) => {
          const actions = [
            { id: 'loans', label: 'Loan', icon: HandCoins, color: theme.hotPink, bg: theme.palePink },
            { id: 'goals', label: 'Goals', icon: Trophy, color: theme.teal, bg: theme.mint },
            { id: 'subs', label: 'Subs', icon: Repeat, color: theme.amber, bg: theme.paleYellow },
            { id: 'more', label: 'More', icon: MoreHorizontal, color: theme.royalBlue, bg: theme.paleBlue },
          ];

          return (
            <div className="flex justify-between px-8 py-8 animate-slide-up-fade" style={{ animationDelay: '0.1s' }}>
              {actions.map((action, idx) => (
                <div key={idx} onClick={() => onNavigate && onNavigate(action.id)} className="flex flex-col items-center gap-3 group cursor-pointer active:scale-95 transition-transform duration-200">
                  <div className={`w-14 h-14 rounded-2xl flex items-center justify-center transition-colors ${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'}`}><action.icon size={22} color={action.color} /></div>
                  <span className={`text-xs font-medium tracking-wide transition-colors ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>{action.label}</span>
                </div>
              ))}
            </div>
          );
        });

        const TransactionItem = React.memo(({ item, isDarkMode, wallets, onClick }) => {
          const IconComponent = getIcon(item.icon);
          
          const getWalletName = (id) => {
              const w = wallets.find(w => w.id === id);
              return w ? w.name : (id === 'Cash' ? 'Cash' : 'Unknown');
          };

          let accountLabel = '';
          if (item.type === 'transfer') {
              accountLabel = `${getWalletName(item.account)} → ${getWalletName(item.toAccount)}`;
          } else {
              accountLabel = getWalletName(item.account);
          }

          return (
            <div onClick={() => onClick && onClick(item)} className={`flex items-center justify-between py-4 px-4 mb-2 rounded-2xl transition-all duration-300 active:scale-[0.98] animate-stagger-in opacity-0 cursor-pointer ${isDarkMode ? 'hover:bg-gray-800' : 'hover:bg-white hover:shadow-sm'}`} style={{ animationFillMode: 'forwards' }}>
              <div className="flex items-center gap-4">
                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'}`}><IconComponent size={20} color={item.color} /></div>
                <div>
                  <h4 className={`font-bold text-sm transition-colors ${isDarkMode ? 'text-white' : ''}`} style={{ color: isDarkMode ? undefined : theme.navy }}>{item.title}</h4>
                  {item.note && (<p className="text-xs text-gray-400 mb-1 truncate max-w-[150px]">{item.note}</p>)}
                  <div className="flex items-center gap-2"><span className="text-xs font-medium text-gray-400">{item.category}</span><span className="text-[10px] text-gray-300">•</span><span className="text-[10px] font-bold text-gray-400">{accountLabel}</span></div>
                </div>
              </div>
              <div className={`font-bold text-sm ${item.type === 'transfer' ? 'text-blue-500' : (item.amount > 0 ? 'text-green-500' : (isDarkMode ? 'text-white' : 'text-gray-800'))}`}>
                {item.type === 'transfer' ? '' : (item.amount > 0 ? '+' : '')}
                {Math.abs(item.amount).toFixed(2)}
              </div>
            </div>
          );
        });

        // ... (LoanItem, SubItem, GoalItem, Charts - No changes needed logic wise, just layout)
        const LoanItem = React.memo(({ item, isDarkMode, onClick }) => (
          <div onClick={() => onClick && onClick(item)} className={`flex items-center justify-between py-4 px-4 mb-2 rounded-2xl transition-all duration-300 active:scale-[0.98] animate-stagger-in opacity-0 cursor-pointer ${isDarkMode ? 'hover:bg-gray-800' : 'hover:bg-white hover:shadow-sm'}`} style={{ animationFillMode: 'forwards' }}>
            <div className="flex items-center gap-4">
              <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${item.type === 'given' ? (isDarkMode ? 'bg-teal-900/30' : 'bg-teal-50') : (isDarkMode ? 'bg-red-900/30' : 'bg-red-50')}`}><User size={20} color={item.type === 'given' ? theme.teal : theme.hotPink} /></div>
              <div>
                <h4 className={`font-bold text-sm transition-colors ${isDarkMode ? 'text-white' : ''}`} style={{ color: isDarkMode ? undefined : theme.navy }}>{item.person}</h4>
                <div className="flex items-center gap-2 mt-1"><span className={`text-[10px] font-bold uppercase tracking-wide px-1.5 py-0.5 rounded ${item.type === 'given' ? 'bg-teal-100 text-teal-700' : 'bg-red-100 text-red-700'}`}>{item.type === 'given' ? 'Given' : 'Taken'}</span><span className="text-[10px] text-gray-400 flex items-center gap-1"><Calendar size={10} /> Due: {item.dueDate}</span></div>
              </div>
            </div>
            <div className={`font-bold text-sm ${item.type === 'given' ? 'text-green-500' : 'text-red-500'}`}>{item.type === 'given' ? '+' : '-'}${Math.abs(item.amount).toLocaleString()}</div>
          </div>
        ));

        const SubItem = React.memo(({ item, isDarkMode, onClick }) => {
          const IconComponent = getIcon(item.icon);
          return (
            <div onClick={() => onClick && onClick(item)} className={`flex items-center justify-between py-4 px-4 mb-2 rounded-2xl transition-all duration-300 active:scale-[0.98] animate-stagger-in opacity-0 cursor-pointer ${isDarkMode ? 'hover:bg-gray-800' : 'hover:bg-white hover:shadow-sm'}`} style={{ animationFillMode: 'forwards' }}>
              <div className="flex items-center gap-4">
                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'}`}><IconComponent size={20} color={item.color} /></div>
                <div>
                  <h4 className={`font-bold text-sm transition-colors ${isDarkMode ? 'text-white' : ''}`} style={{ color: isDarkMode ? undefined : theme.navy }}>{item.name}</h4>
                  <div className="flex items-center gap-2 mt-1"><span className={`text-[10px] font-bold uppercase tracking-wide px-1.5 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-500`}>{item.cycle}</span><span className="text-[10px] text-gray-400">Next: {item.nextDate}</span></div>
                </div>
              </div>
              <div className={`font-bold text-sm ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>${item.cost}</div>
            </div>
          );
        });

        const GoalItem = React.memo(({ item, isDarkMode, onClick }) => {
          const percentage = Math.min(100, Math.round((item.saved / item.target) * 100));
          const IconComponent = getIcon(item.icon);
          
          return (
            <div onClick={() => onClick && onClick(item)} className={`p-5 mb-3 rounded-[1.5rem] transition-all duration-300 active:scale-[0.98] animate-stagger-in opacity-0 cursor-pointer ${isDarkMode ? 'bg-gray-800' : 'bg-white shadow-sm hover:shadow-md'}`} style={{ animationFillMode: 'forwards' }}>
              <div className="flex justify-between items-start mb-3">
                <div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-xl flex items-center justify-center ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}><IconComponent size={20} color={item.color} /></div><div><h4 className={`font-bold text-sm ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{item.title}</h4><p className="text-[10px] text-gray-400 font-medium mt-0.5">By {item.deadline}</p></div></div>
                <div className="text-right"><span className={`text-sm font-bold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>${item.saved.toLocaleString()}</span><p className="text-[10px] text-gray-400">of ${item.target.toLocaleString()}</p></div>
              </div>
              <div className={`h-2 w-full rounded-full ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}><div className="h-full rounded-full transition-all duration-1000 ease-out" style={{ width: `${percentage}%`, backgroundColor: item.color }}></div></div>
              <div className="flex justify-between mt-2"><span className="text-[10px] font-bold text-gray-400">{percentage}%</span><span className="text-[10px] font-bold text-gray-400">Left: ${(item.target - item.saved).toLocaleString()}</span></div>
            </div>
          );
        });

        const DonutChart = ({ data, isDarkMode }) => {
          const total = useMemo(() => data.reduce((acc, curr) => acc + curr.value, 0), [data]);
          let accumulatedAngle = 0;

          return (
            <div className="relative w-full max-w-[200px] aspect-square mx-auto my-6 animate-scale-in">
              <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full overflow-visible">
                {data.map((slice, i) => {
                  const percentage = total > 0 ? slice.value / total : 0;
                  const angle = percentage * 360;
                  const radius = 40; 
                  const circumference = 2 * Math.PI * radius;
                  const strokeLength = percentage * circumference;
                  const spaceLength = circumference - strokeLength; 
                  accumulatedAngle += angle;

                  if (total === 0) return null;

                  return (
                    <circle
                      key={i}
                      cx="50"
                      cy="50"
                      r={radius}
                      fill="transparent"
                      stroke={slice.color}
                      strokeWidth="12" 
                      strokeDasharray={`${strokeLength} ${spaceLength}`}
                      strokeDashoffset={-((accumulatedAngle - angle) / 360) * circumference}
                      strokeLinecap="round" 
                      className="origin-center transition-all duration-300 hover:opacity-80"
                    />
                  );
                })}
                <circle cx="50" cy="50" r="28" fill="transparent" /> 
              </svg>
              <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <span className="text-[10px] font-medium text-gray-400 uppercase tracking-widest">Total</span>
                <span className={`text-xl font-bold transition-colors ${isDarkMode ? 'text-white' : ''}`} style={{ color: isDarkMode ? undefined : theme.navy }}>${total.toLocaleString()}</span>
              </div>
            </div>
          );
        };

        const BarChart = ({ data, isDarkMode }) => {
          const max = Math.max(...data.map(d => d.value), 1);
          const [mounted, setMounted] = useState(false);
          
          useEffect(() => setMounted(true), []);

          // Define colorful vibrant gradients
          const barGradients = [
             `linear-gradient(to top, ${theme.royalBlue}, ${theme.skyBlue})`,
             `linear-gradient(to top, ${theme.teal}, ${theme.aqua})`,
             `linear-gradient(to top, ${theme.amber}, ${theme.yellow})`,
             `linear-gradient(to top, ${theme.red}, ${theme.salmon})`,
             `linear-gradient(to top, ${theme.hotPink}, ${theme.lightPink})`,
             `linear-gradient(to top, ${theme.purple}, ${theme.lavender})`,
             `linear-gradient(to top, ${theme.royalBlue}, ${theme.paleBlue})` 
          ];

          return (
            <div className="flex items-end justify-between h-56 gap-2 pt-8 pb-2 px-2">
              {data.map((bar, i) => {
                const heightPct = (bar.value / max) * 100;
                // Cycle through vibrant gradients based on index
                const currentGradient = barGradients[i % barGradients.length];
                
                return (
                  <div key={i} className="flex flex-col items-center flex-1 h-full justify-end group relative cursor-pointer">
                    {/* Amount Label - Floating above */}
                    <div 
                        className={`absolute -top-8 transition-all duration-500 transform 
                        ${bar.value > 0 ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'}
                        text-[10px] font-bold ${isDarkMode ? 'text-white' : ''} bg-white dark:bg-gray-700 px-2 py-1 rounded-full whitespace-nowrap z-10 shadow-sm border border-gray-100 dark:border-gray-600`}
                        style={{ color: isDarkMode ? undefined : theme.navy }}
                    >
                      ${bar.value >= 1000 ? (bar.value/1000).toFixed(1) + 'k' : Math.round(bar.value)}
                    </div>

                    {/* The Bar Track */}
                    <div className="w-full max-w-[16px] sm:max-w-[24px] h-full rounded-full bg-gray-100 dark:bg-gray-800 relative overflow-hidden flex items-end">
                        {/* The Bar Fill */}
                        <div 
                          className={`w-full rounded-full relative transition-all duration-1000 ease-[cubic-bezier(0.34,1.56,0.64,1)]`}
                          style={{ 
                            height: mounted ? `${Math.max(heightPct, 0)}%` : '0%', 
                            background: currentGradient,
                            opacity: bar.value === 0 ? 0 : 1
                          }}
                        >
                        </div>
                    </div>
                    
                    {/* Day Label */}
                    <span className={`mt-3 text-[10px] font-bold uppercase tracking-wider ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                        {bar.day.charAt(0)}
                    </span>
                  </div>
                );
              })}
            </div>
          );
        };


        // --- Modals ---

        const TransactionModal = ({ isOpen, onClose, onSave, onDelete, initialData, isDarkMode, showToast, wallets, onManageWallets }) => {
          const [amount, setAmount] = useState('');
          const [title, setTitle] = useState('');
          const [type, setType] = useState('expense'); // 'expense' | 'income' | 'transfer'
          const [category, setCategory] = useState('Food');
          const [account, setAccount] = useState('Cash'); // Holds wallet ID
          const [toAccount, setToAccount] = useState('Cash'); // For transfer, holds wallet ID
          const [note, setNote] = useState('');
          const [date, setDate] = useState(formatDateToISO(new Date()));
          const [isDigital, setIsDigital] = useState(false); // Helper for UI toggle
          const [isToDigital, setIsToDigital] = useState(false);

          useEffect(() => {
            if (initialData) {
              setAmount(Math.abs(initialData.amount));
              setTitle(initialData.title);
              setType(initialData.type || (initialData.amount > 0 ? 'income' : 'expense'));
              setCategory(initialData.category);
              setAccount(initialData.account); 
              setNote(initialData.note || '');
              setDate(initialData.date);
              if (initialData.type === 'transfer') {
                 setToAccount(initialData.toAccount);
                 setIsToDigital(initialData.toAccount !== 'Cash');
              }
              setIsDigital(initialData.account !== 'Cash');
            } else {
              setAmount(''); setTitle(''); setType('expense'); setCategory('Food'); 
              setAccount('Cash'); setIsDigital(false);
              setToAccount('Cash'); setIsToDigital(false);
              setNote('');
              setDate(formatDateToISO(new Date())); 
            }
          }, [initialData, isOpen]);

          if (!isOpen) return null;

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!amount || !title) {
                if (showToast) showToast("Please enter an amount and title", "error");
                return;
            }

            onSave({ 
              id: initialData ? initialData.id : Date.now(),
              amount: parseFloat(amount), 
              title, 
              type, 
              category: type === 'transfer' ? 'Transfer' : category, 
              account, 
              toAccount: type === 'transfer' ? toAccount : null,
              note,
              date: date 
            });
            onClose();
          };

          // Handler for dropdown selection
          const handleAccountChange = (val, setFunc, setToggleFunc) => {
              if (val === 'MANAGE') {
                  onManageWallets();
                  return;
              }
              setFunc(val);
          };
          
          // Handler for big buttons (Cash / Digital)
          const handleTypeToggle = (digital, setAccFunc, setToggleFunc) => {
              setToggleFunc(digital);
              if (!digital) {
                  setAccFunc('Cash'); // Reset to Cash ID
              } else {
                  // Default to first non-cash wallet if available, or keep current if valid, or just first available
                  const firstDigital = wallets.find(w => w.id !== 'Cash');
                  setAccFunc(firstDigital ? firstDigital.id : 'Cash'); 
              }
          };

          const categories = ['Food', 'Transport', 'Shopping', 'Bills', 'Entertainment', 'Health', 'Income', 'Other'];
          
          // Filter wallets for dropdown
          const digitalWallets = wallets.filter(w => w.id !== 'Cash');

          return (
            <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
              <div className="absolute inset-0 bg-black/20 backdrop-blur-sm pointer-events-auto transition-opacity animate-fade-in" onClick={onClose}></div>
              <div className={`w-full max-w-md p-6 rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl transform transition-transform duration-300 pointer-events-auto max-h-[85vh] overflow-y-auto ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}>
                <div className="flex justify-between items-center mb-8">
                  <h3 className={`text-xl font-bold tracking-tight ${isDarkMode ? 'text-white' : 'text-[#052065]'}`}>{initialData ? 'Edit Transaction' : 'New Transaction'}</h3>
                  <button onClick={onClose} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}`}><X size={24} /></button>
                </div>
                <form onSubmit={handleSubmit} className="flex flex-col gap-6">
                  <div className={`flex p-1 rounded-xl ${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                    <button type="button" onClick={() => setType('income')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${type === 'income' ? (isDarkMode ? 'bg-gray-700 text-white shadow-sm' : 'bg-white text-teal-600 shadow-sm') : 'text-gray-400'}`}>Income</button>
                    <button type="button" onClick={() => setType('expense')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${type === 'expense' ? (isDarkMode ? 'bg-gray-700 text-white shadow-sm' : 'bg-white text-pink-500 shadow-sm') : 'text-gray-400'}`}>Expense</button>
                    <button type="button" onClick={() => setType('transfer')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${type === 'transfer' ? (isDarkMode ? 'bg-gray-700 text-white shadow-sm' : 'bg-white text-blue-500 shadow-sm') : 'text-gray-400'}`}>Transfer</button>
                  </div>
                  
                  <div>
                    <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Amount</label>
                    <div className={`flex items-center pb-2 border-b-2 transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                      <span className="text-2xl font-bold mr-2 opacity-50">$</span>
                      <input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0.00" className="bg-transparent w-full text-4xl font-bold outline-none" autoFocus />
                    </div>
                  </div>

                  <div>
                    <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Date</label>
                    <div className={`flex items-center pb-2 border-b-2 transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                      <Calendar size={20} className="mr-3 opacity-50" />
                      <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="bg-transparent w-full font-medium text-lg outline-none" />
                    </div>
                  </div>

                  <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Title</label><input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder={type === 'transfer' ? "Transfer reason" : "What is this for?"} className={`w-full pb-2 border-b-2 bg-transparent outline-none font-medium text-lg transition-all ${isDarkMode ? 'border-gray-700 focus:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`} /></div>
                  
                  {type !== 'transfer' && (
                    <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 block">Category</label><div className="flex flex-wrap gap-2">{categories.map(cat => (<button key={cat} type="button" onClick={() => setCategory(cat)} className={`px-4 py-2 rounded-full text-xs font-bold border transition-all ${category === cat ? (isDarkMode ? 'bg-white text-gray-900 border-white' : 'bg-gray-900 text-white border-gray-900') : (isDarkMode ? 'border-gray-700 text-gray-400 hover:border-gray-500' : 'border-gray-200 text-gray-500 hover:border-gray-400')}`}>{cat}</button>))}</div></div>
                  )}
                  
                  {/* FROM ACCOUNT SELECTOR */}
                  <div>
                      <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 block">{type === 'transfer' ? 'From Account' : 'Account'}</label>
                      <div className="grid grid-cols-2 gap-3 mb-3">
                          <button type="button" onClick={() => handleTypeToggle(false, setAccount, setIsDigital)} className={`flex flex-col items-center justify-center gap-2 py-3 rounded-xl border transition-all ${!isDigital ? (isDarkMode ? 'border-teal-500 text-teal-400 bg-teal-500/10' : 'border-teal-500 text-teal-600 bg-teal-50') : (isDarkMode ? 'border-gray-700 text-gray-400' : 'border-gray-200 text-gray-400')}`}>
                              <Banknote size={18} />
                              <span className="font-bold text-xs truncate w-full px-1">Cash</span>
                          </button>
                          <button type="button" onClick={() => handleTypeToggle(true, setAccount, setIsDigital)} className={`flex flex-col items-center justify-center gap-2 py-3 rounded-xl border transition-all ${isDigital ? (isDarkMode ? 'border-purple-500 text-purple-400 bg-purple-500/10' : 'border-purple-500 text-purple-600 bg-purple-50') : (isDarkMode ? 'border-gray-700 text-gray-400' : 'border-gray-200 text-gray-400')}`}>
                              <CreditCard size={18} />
                              <span className="font-bold text-xs truncate w-full px-1">Digital / Bank</span>
                          </button>
                      </div>
                      
                      {isDigital && (
                          <div className={`p-3 rounded-xl border border-dashed flex items-center gap-3 animate-fade-in ${isDarkMode ? 'border-gray-700 bg-gray-800/50' : 'border-gray-200 bg-gray-50'}`}>
                              <div className={`p-2 rounded-lg shrink-0 ${isDarkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-600'}`}>
                                   <Landmark size={16} />
                              </div>
                              <div className="flex-1">
                                  <p className={`text-xs font-bold uppercase tracking-wide mb-1 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>Select Source Wallet</p>
                                  <div className="relative">
                                    <select 
                                        value={account} 
                                        onChange={(e) => handleAccountChange(e.target.value, setAccount, setIsDigital)}
                                        className={`w-full bg-transparent font-bold text-sm outline-none appearance-none pr-4 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}
                                    >
                                        {digitalWallets.map(w => (
                                            <option key={w.id} value={w.id}>{w.name}</option>
                                        ))}
                                        <option disabled>──────────</option>
                                        <option value="MANAGE" className="font-bold text-blue-500">+ Add/Edit Bank Details</option>
                                    </select>
                                    <ChevronDown size={14} className="absolute right-0 top-1/2 -translate-y-1/2 opacity-50 pointer-events-none" />
                                  </div>
                              </div>
                          </div>
                      )}
                  </div>

                  {/* TO ACCOUNT SELECTOR (ONLY FOR TRANSFER) */}
                  {type === 'transfer' && (
                     <div className="animate-fade-in border-t border-dashed pt-4 border-gray-200 dark:border-gray-700">
                        <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 block">To Account</label>
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <button type="button" onClick={() => handleTypeToggle(false, setToAccount, setIsToDigital)} className={`flex flex-col items-center justify-center gap-2 py-3 rounded-xl border transition-all ${!isToDigital ? (isDarkMode ? 'border-teal-500 text-teal-400 bg-teal-500/10' : 'border-teal-500 text-teal-600 bg-teal-50') : (isDarkMode ? 'border-gray-700 text-gray-400' : 'border-gray-200 text-gray-400')}`}>
                                <Banknote size={18} />
                                <span className="font-bold text-xs truncate w-full px-1">Cash</span>
                            </button>
                            <button type="button" onClick={() => handleTypeToggle(true, setToAccount, setIsToDigital)} className={`flex flex-col items-center justify-center gap-2 py-3 rounded-xl border transition-all ${isToDigital ? (isDarkMode ? 'border-purple-500 text-purple-400 bg-purple-500/10' : 'border-purple-500 text-purple-600 bg-purple-50') : (isDarkMode ? 'border-gray-700 text-gray-400' : 'border-gray-200 text-gray-400')}`}>
                                <CreditCard size={18} />
                                <span className="font-bold text-xs truncate w-full px-1">Digital / Bank</span>
                            </button>
                        </div>
                        
                        {isToDigital && (
                            <div className={`p-3 rounded-xl border border-dashed flex items-center gap-3 animate-fade-in ${isDarkMode ? 'border-gray-700 bg-gray-800/50' : 'border-gray-200 bg-gray-50'}`}>
                                <div className={`p-2 rounded-lg shrink-0 ${isDarkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-600'}`}>
                                     <ArrowRightLeft size={16} />
                                </div>
                                <div className="flex-1">
                                    <p className={`text-xs font-bold uppercase tracking-wide mb-1 ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>Select Target Wallet</p>
                                    <div className="relative">
                                      <select 
                                          value={toAccount} 
                                          onChange={(e) => handleAccountChange(e.target.value, setToAccount, setIsToDigital)}
                                          className={`w-full bg-transparent font-bold text-sm outline-none appearance-none pr-4 ${isDarkMode ? 'text-white' : 'text-gray-800'}`}
                                      >
                                          {digitalWallets.map(w => (
                                              <option key={w.id} value={w.id}>{w.name}</option>
                                          ))}
                                          <option disabled>──────────</option>
                                          <option value="MANAGE" className="font-bold text-blue-500">+ Add/Edit Bank Details</option>
                                      </select>
                                      <ChevronDown size={14} className="absolute right-0 top-1/2 -translate-y-1/2 opacity-50 pointer-events-none" />
                                    </div>
                                </div>
                            </div>
                        )}
                     </div>
                  )}

                  <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Note</label><div className="flex gap-3"><div className={`flex-1 flex items-center px-5 py-3 rounded-2xl border transition-all ${isDarkMode ? 'border-gray-700 text-white' : 'border-gray-200 text-gray-800'}`}><FileText size={18} className="mr-3 opacity-40" /><input type="text" value={note} onChange={(e) => setNote(e.target.value)} placeholder="Write a note..." className="bg-transparent w-full font-medium outline-none" /></div><div className={`w-14 h-14 rounded-2xl flex items-center justify-center border transition-all active:scale-95 ${isDarkMode ? 'border-gray-700 text-gray-400 hover:text-white hover:border-gray-500' : 'border-gray-200 text-gray-400 hover:text-gray-600 hover:border-gray-200'}`}><ImageIcon size={22} /></div></div></div>
                  
                  <div className="flex gap-4 mt-2">
                     {initialData && (
                       <button type="button" onClick={() => { onDelete(initialData.id); onClose(); }} className="p-4 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors">
                         <Trash2 size={24} />
                       </button>
                     )}
                     <button type="submit" className="flex-1 py-4 rounded-xl text-white font-bold text-lg shadow-md active:scale-[0.98] transition-all" style={{ background: type === 'income' ? theme.teal : (type === 'transfer' ? theme.royalBlue : theme.hotPink) }}>{initialData ? 'Update' : 'Save'}</button>
                  </div>
                </form>
              </div>
            </div>
          );
        };

        const LoanModal = ({ isOpen, onClose, onSave, onDelete, initialData, isDarkMode, showToast }) => {
          const [amount, setAmount] = useState('');
          const [person, setPerson] = useState('');
          const [type, setType] = useState('taken');
          const [dueDate, setDueDate] = useState('');

          useEffect(() => {
            if (initialData) {
              setAmount(initialData.amount);
              setPerson(initialData.person);
              setType(initialData.type);
              setDueDate(initialData.dueDate ? formatDateToISO(new Date(initialData.dueDate)) : ''); 
            } else {
              setAmount(''); setPerson(''); setType('taken'); setDueDate('');
            }
          }, [initialData, isOpen]);

          if (!isOpen) return null;

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!amount || !person) {
                if (showToast) showToast("Please enter an amount and person name", "error");
                return;
            }
            onSave({ 
              id: initialData ? initialData.id : Date.now(),
              amount: parseFloat(amount), 
              person, 
              type, 
              date: initialData ? initialData.date : formatDateToISO(new Date()),
              dueDate: dueDate ? new Date(dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : (initialData ? initialData.dueDate : 'No Due Date'),
              status: 'active'
            });
            onClose();
          };

          return (
            <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
              <div className="absolute inset-0 bg-black/20 backdrop-blur-sm pointer-events-auto transition-opacity animate-fade-in" onClick={onClose}></div>
              <div className={`w-full max-w-md p-6 rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl transform transition-transform duration-300 pointer-events-auto max-h-[85vh] overflow-y-auto ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}>
                <div className="flex justify-between items-center mb-8">
                  <h3 className={`text-xl font-bold tracking-tight ${isDarkMode ? 'text-white' : 'text-[#052065]'}`}>{initialData ? 'Edit Loan' : 'Add New Loan'}</h3>
                  <button onClick={onClose} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}`}><X size={24} /></button>
                </div>
                <form onSubmit={handleSubmit} className="flex flex-col gap-6">
                  <div className={`flex p-1 rounded-xl ${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                    <button type="button" onClick={() => setType('taken')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${type === 'taken' ? (isDarkMode ? 'bg-gray-700 text-red-400 shadow-sm' : 'bg-white text-red-500 shadow-sm') : 'text-gray-400'}`}>I Borrowed</button>
                    <button type="button" onClick={() => setType('given')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${type === 'given' ? (isDarkMode ? 'bg-gray-700 text-teal-400 shadow-sm' : 'bg-white text-teal-600 shadow-sm') : 'text-gray-400'}`}>I Lent</button>
                  </div>
                  <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Amount</label><div className={`flex items-center pb-2 border-b-2 transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}><span className="text-2xl font-bold mr-2 opacity-50">$</span><input type="number" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="0.00" className="bg-transparent w-full text-4xl font-bold outline-none" autoFocus /></div></div>
                  <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Person Name</label><div className={`flex items-center pb-2 border-b-2 transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}><User size={20} className="mr-3 opacity-50" /><input type="text" value={person} onChange={(e) => setPerson(e.target.value)} placeholder="Who is this?" className="bg-transparent w-full font-medium text-lg outline-none" /></div></div>
                  <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Due Date</label><div className={`flex items-center pb-2 border-b-2 transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}><Calendar size={20} className="mr-3 opacity-50" /><input type="date" value={dueDate} onChange={(e) => setDueDate(e.target.value)} className="bg-transparent w-full font-medium text-lg outline-none" /></div></div>
                  
                  <div className="flex gap-4 mt-2">
                     {initialData && (
                       <button type="button" onClick={() => { onDelete(initialData.id); onClose(); }} className="p-4 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors">
                         <Trash2 size={24} />
                       </button>
                     )}
                     <button type="submit" className="flex-1 py-4 rounded-xl text-white font-bold text-lg shadow-md active:scale-[0.98] transition-all" style={{ background: type === 'given' ? theme.teal : theme.hotPink }}>
                       {initialData ? 'Update Loan' : 'Save Loan Record'}
                     </button>
                  </div>
                </form>
              </div>
            </div>
          );
        };

        // --- New Subscription Modal (Add/Edit) ---
        const SubscriptionModal = ({ isOpen, onClose, onSave, onDelete, initialData, isDarkMode, showToast }) => {
          const [name, setName] = useState('');
          const [cost, setCost] = useState('');
          const [cycle, setCycle] = useState('Monthly');
          const [nextDate, setNextDate] = useState('');

          useEffect(() => {
            if (initialData) {
              setName(initialData.name);
              setCost(initialData.cost);
              setCycle(initialData.cycle);
              setNextDate(initialData.nextDate ? formatDateToISO(new Date(initialData.nextDate)) : ''); 
            } else {
              setName(''); setCost(''); setCycle('Monthly'); setNextDate('');
            }
          }, [initialData, isOpen]);

          if (!isOpen) return null;

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!name || !cost) {
                if (showToast) showToast("Please enter name and cost", "error");
                return;
            }
            onSave({
              id: initialData ? initialData.id : Date.now(),
              name,
              cost: parseFloat(cost),
              cycle,
              nextDate: nextDate ? new Date(nextDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : (initialData ? initialData.nextDate : 'Set Date'),
              icon: 'Zap',
              color: theme.royalBlue
            });
            onClose();
          };

          return (
            <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
              <div className="absolute inset-0 bg-black/20 backdrop-blur-sm pointer-events-auto transition-opacity animate-fade-in" onClick={onClose}></div>
              <div className={`w-full max-w-md p-6 rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl transform transition-transform duration-300 pointer-events-auto max-h-[85vh] overflow-y-auto ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}>
                <div className="flex justify-between items-center mb-8">
                  <h3 className={`text-xl font-bold tracking-tight ${isDarkMode ? 'text-white' : 'text-[#052065]'}`}>{initialData ? 'Edit Subscription' : 'New Subscription'}</h3>
                  <button onClick={onClose} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}`}><X size={24} /></button>
                </div>
                <form onSubmit={handleSubmit} className="flex flex-col gap-6">
                  <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Service Name</label><div className={`flex items-center pb-2 border-b-2 transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}><Zap size={20} className="mr-3 opacity-50" /><input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g. Netflix" className="bg-transparent w-full font-medium text-lg outline-none" autoFocus /></div></div>
                  <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Cost</label><div className={`flex items-center pb-2 border-b-2 transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}><span className="text-2xl font-bold mr-2 opacity-50">$</span><input type="number" value={cost} onChange={(e) => setCost(e.target.value)} placeholder="0.00" className="bg-transparent w-full text-4xl font-bold outline-none" /></div></div>
                  <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Cycle</label><div className={`flex items-center pb-2 border-b-2 transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}><Repeat size={20} className="mr-3 opacity-50" /><select value={cycle} onChange={(e) => setCycle(e.target.value)} className={`bg-transparent w-full font-medium text-lg outline-none ${isDarkMode ? 'text-white' : 'text-gray-800'}`}><option value="Monthly">Monthly</option><option value="Yearly">Yearly</option><option value="Weekly">Weekly</option></select></div></div>
                  <div><label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Next Payment</label><div className={`flex items-center pb-2 border-b-2 transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}><Calendar size={20} className="mr-3 opacity-50" /><input type="date" value={nextDate} onChange={(e) => setNextDate(e.target.value)} className="bg-transparent w-full font-medium text-lg outline-none" /></div></div>
                  
                  <div className="flex gap-4 mt-2">
                     {initialData && (
                       <button type="button" onClick={() => { onDelete(initialData.id); onClose(); }} className="p-4 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors">
                         <Trash2 size={24} />
                       </button>
                     )}
                     <button type="submit" className="flex-1 py-4 rounded-xl text-white font-bold text-lg shadow-md active:scale-[0.98] transition-all" style={{ background: theme.royalBlue }}>
                       {initialData ? 'Update Sub' : 'Add Subscription'}
                     </button>
                  </div>
                </form>
              </div>
            </div>
          );
        };

        const AddGoalModal = ({ isOpen, onClose, onSave, onDelete, initialData, isDarkMode, showToast }) => {
          const [title, setTitle] = useState('');
          const [target, setTarget] = useState('');
          const [saved, setSaved] = useState('');
          const [deadline, setDeadline] = useState('');

          useEffect(() => {
            if (initialData) {
              setTitle(initialData.title);
              setTarget(initialData.target);
              setSaved(initialData.saved);
              setDeadline(initialData.deadline ? formatDateToISO(new Date(initialData.deadline)) : '');
            } else {
              setTitle(''); setTarget(''); setSaved(''); setDeadline('');
            }
          }, [initialData, isOpen]);

          if (!isOpen) return null;

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!title || !target) {
                if (showToast) showToast("Please enter a goal title and target amount", "error");
                return;
            }
            onSave({ 
              id: initialData ? initialData.id : Date.now(),
              title, 
              target: parseFloat(target), 
              saved: parseFloat(saved) || 0,
              deadline: deadline ? new Date(deadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'No Date',
              color: theme.royalBlue, 
              icon: 'Target'
            });
            setTitle(''); setTarget(''); setSaved(''); setDeadline(''); onClose();
          };

          return (
            <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
              <div 
                className="absolute inset-0 bg-black/20 backdrop-blur-sm pointer-events-auto transition-opacity animate-fade-in"
                onClick={onClose}
              ></div>
              
              <div className={`w-full max-w-md p-6 rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl transform transition-transform duration-300 pointer-events-auto max-h-[85vh] overflow-y-auto ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}>
                <div className="flex justify-between items-center mb-8">
                  <h3 className={`text-xl font-bold tracking-tight ${isDarkMode ? 'text-white' : 'text-[#052065]'}`}>{initialData ? 'Edit Goal' : 'Add New Goal'}</h3>
                  <button onClick={onClose} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}`}>
                    <X size={24} />
                  </button>
                </div>

                <form onSubmit={handleSubmit} className="flex flex-col gap-6">
                  {/* Title */}
                  <div>
                    <label className="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1 mb-2 block">Goal Name</label>
                    <div className={`flex items-center px-5 py-4 rounded-2xl border-2 transition-all ${isDarkMode ? 'bg-gray-900/50 border-gray-700 text-white' : 'bg-gray-50 border-gray-100 text-gray-800'} focus-within:border-blue-500 focus-within:ring-4 focus-within:ring-blue-500/10`}>
                      <Trophy size={20} className="mr-3 opacity-50" />
                      <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="e.g. New Laptop" className="bg-transparent w-full font-medium text-lg outline-none" autoFocus />
                    </div>
                  </div>

                  {/* Target */}
                  <div>
                    <label className="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1 mb-2 block">Target Amount</label>
                    <div className={`flex items-center px-5 py-4 rounded-2xl border-2 transition-all ${isDarkMode ? 'bg-gray-900/50 border-gray-700 text-white' : 'bg-gray-50 border-gray-100 text-gray-800'} focus-within:border-blue-500 focus-within:ring-4 focus-within:ring-blue-500/10`}>
                      <span className="text-2xl font-bold mr-2 opacity-50">$</span>
                      <input type="number" value={target} onChange={(e) => setTarget(e.target.value)} placeholder="0.00" className="bg-transparent w-full text-4xl font-bold outline-none" />
                    </div>
                  </div>

                  {/* Initial Saved */}
                  <div>
                    <label className="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1 mb-2 block">Already Saved</label>
                    <div className={`flex items-center px-5 py-4 rounded-2xl border-2 transition-all ${isDarkMode ? 'bg-gray-900/50 border-gray-700 text-white' : 'bg-gray-50 border-gray-100 text-gray-800'} focus-within:border-blue-500 focus-within:ring-4 focus-within:ring-blue-500/10`}>
                      <span className="text-xl font-bold mr-2 opacity-50">$</span>
                      <input type="number" value={saved} onChange={(e) => setSaved(e.target.value)} placeholder="0.00" className="bg-transparent w-full text-4xl font-bold outline-none" />
                    </div>
                  </div>

                  {/* Deadline */}
                  <div>
                    <label className="text-xs font-bold text-gray-400 uppercase tracking-widest ml-1 mb-2 block">Target Date</label>
                    <div className={`flex items-center px-5 py-4 rounded-2xl border-2 transition-all ${isDarkMode ? 'bg-gray-900/50 border-gray-700 text-white' : 'bg-gray-50 border-gray-100 text-gray-800'} focus-within:border-blue-500 focus-within:ring-4 focus-within:ring-blue-500/10`}>
                      <Calendar size={20} className="mr-3 opacity-50" />
                      <input type="date" value={deadline} onChange={(e) => setDeadline(e.target.value)} className="bg-transparent w-full font-medium text-lg outline-none" />
                    </div>
                  </div>

                  <div className="flex gap-4 mt-2">
                     {initialData && (
                       <button type="button" onClick={() => { onDelete(initialData.id); onClose(); }} className="p-4 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 transition-colors">
                         <Trash2 size={24} />
                       </button>
                     )}
                     <button type="submit" className="flex-1 py-4 rounded-xl text-white font-bold text-lg shadow-md active:scale-[0.98] transition-all"
                      style={{ background: theme.royalBlue }}>
                      {initialData ? 'Update Goal' : 'Create Goal'}
                     </button>
                  </div>
                </form>
              </div>
            </div>
          );
        };

        const WalletDetailsModal = ({ isOpen, onClose, onSave, wallet, isDarkMode, showToast, isNew }) => {
          const [formData, setFormData] = useState({
            name: '',
            type: 'Bank',
            bankName: '',
            accountNumber: '',
            holderName: '',
            district: '',
            branch: '',
            mobile: '',
            email: ''
          });

          useEffect(() => {
            if (wallet) {
                setFormData({
                    name: wallet.name || '',
                    type: wallet.type || 'Bank',
                    bankName: wallet.details?.bankName || '',
                    accountNumber: wallet.details?.accountNumber || '',
                    holderName: wallet.details?.holderName || '',
                    district: wallet.details?.district || '',
                    branch: wallet.details?.branch || '',
                    mobile: wallet.details?.mobile || '',
                    email: wallet.details?.email || ''
                });
            } else {
                setFormData({
                    name: '', type: 'Bank', bankName: '', accountNumber: '', holderName: '', district: '', branch: '', mobile: '', email: ''
                });
            }
          }, [wallet, isOpen]);

          if(!isOpen) return null;

          const handleChange = (e) => {
              const { name, value } = e.target;
              setFormData(prev => ({ ...prev, [name]: value }));
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              // Prepare wallet object
              const walletData = {
                  id: wallet?.id || Date.now().toString(),
                  name: formData.name || (formData.type === 'Cash' ? 'Cash' : formData.bankName),
                  type: formData.type,
                  color: wallet?.color || getRandomThemeColor(),
                  isDefault: false,
                  details: {
                      bankName: formData.bankName,
                      accountNumber: formData.accountNumber,
                      holderName: formData.holderName,
                      district: formData.district,
                      branch: formData.branch,
                      mobile: formData.mobile,
                      email: formData.email
                  }
              };

              onSave(walletData);
              onClose();
              if(showToast) showToast(`Wallet ${isNew ? 'added' : 'updated'} successfully!`, 'success');
          };

          return (
            <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
              <div className="absolute inset-0 bg-black/20 backdrop-blur-sm pointer-events-auto transition-opacity animate-fade-in" onClick={onClose}></div>
              <div className={`w-full max-w-md p-6 rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl transform transition-transform duration-300 pointer-events-auto max-h-[85vh] overflow-y-auto ${isDarkMode ? 'bg-gray-900' : 'bg-white'}`}>
                <div className="flex justify-between items-center mb-6">
                  <h3 className={`text-xl font-bold tracking-tight ${isDarkMode ? 'text-white' : 'text-[#052065]'}`}>{isNew ? 'Add New Wallet' : 'Edit Wallet Details'}</h3>
                  <button onClick={onClose} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}`}><X size={24} /></button>
                </div>
                <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                    {/* Wallet Type Selection */}
                     <div className={`flex p-1 rounded-xl mb-2 ${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                        {['Bank', 'Card', 'Cash'].map(t => (
                            <button 
                                key={t}
                                type="button" 
                                onClick={() => setFormData({...formData, type: t})} 
                                className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${formData.type === t ? (isDarkMode ? 'bg-gray-700 text-white shadow-sm' : 'bg-white text-blue-600 shadow-sm') : 'text-gray-400'}`}
                            >
                                {t}
                            </button>
                        ))}
                    </div>

                    <div>
                        <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 block">Wallet Nickname</label>
                        <div className={`flex items-center px-4 py-3 rounded-xl border transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                            <Wallet size={18} className="mr-3 opacity-50" />
                            <input type="text" name="name" value={formData.name} onChange={handleChange} placeholder="e.g. My Savings" className="bg-transparent w-full font-medium outline-none" autoFocus />
                        </div>
                    </div>

                    {formData.type !== 'Cash' && (
                        <>
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 block">Bank/Issuer Name</label>
                                <div className={`flex items-center px-4 py-3 rounded-xl border transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                                    <Building size={18} className="mr-3 opacity-50" />
                                    <input type="text" name="bankName" value={formData.bankName || ''} onChange={handleChange} placeholder="e.g. Chase Bank" className="bg-transparent w-full font-medium outline-none" />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 block">Account Number</label>
                                <div className={`flex items-center px-4 py-3 rounded-xl border transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                                    <CreditCard size={18} className="mr-3 opacity-50" />
                                    <input type="text" name="accountNumber" value={formData.accountNumber || ''} onChange={handleChange} placeholder="Account Number" className="bg-transparent w-full font-medium outline-none" />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 block">Holder Name</label>
                                <div className={`flex items-center px-4 py-3 rounded-xl border transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                                    <User size={18} className="mr-3 opacity-50" />
                                    <input type="text" name="holderName" value={formData.holderName || ''} onChange={handleChange} placeholder="Account Holder Name" className="bg-transparent w-full font-medium outline-none" />
                                </div>
                            </div>
                            <div className="flex gap-3">
                                <div className="flex-1">
                                    <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 block">District</label>
                                    <div className={`flex items-center px-4 py-3 rounded-xl border transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                                        <MapPin size={18} className="mr-3 opacity-50" />
                                        <input type="text" name="district" value={formData.district || ''} onChange={handleChange} placeholder="District" className="bg-transparent w-full font-medium outline-none" />
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 block">Branch</label>
                                    <div className={`flex items-center px-4 py-3 rounded-xl border transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                                        <Landmark size={18} className="mr-3 opacity-50" />
                                        <input type="text" name="branch" value={formData.branch || ''} onChange={handleChange} placeholder="Branch" className="bg-transparent w-full font-medium outline-none" />
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 block">Mobile Number</label>
                                <div className={`flex items-center px-4 py-3 rounded-xl border transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                                    <Phone size={18} className="mr-3 opacity-50" />
                                    <input type="tel" name="mobile" value={formData.mobile || ''} onChange={handleChange} placeholder="Mobile Number" className="bg-transparent w-full font-medium outline-none" />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 block">Email Address</label>
                                <div className={`flex items-center px-4 py-3 rounded-xl border transition-all ${isDarkMode ? 'border-gray-700 focus-within:border-white text-white' : 'border-gray-200 focus:border-gray-800 text-gray-800'}`}>
                                    <Mail size={18} className="mr-3 opacity-50" />
                                    <input type="email" name="email" value={formData.email || ''} onChange={handleChange} placeholder="Email Address" className="bg-transparent w-full font-medium outline-none" />
                                </div>
                            </div>
                        </>
                    )}

                    <button type="submit" className="w-full py-4 mt-2 rounded-xl text-white font-bold text-lg shadow-md active:scale-[0.98] transition-all" style={{ background: theme.royalBlue }}>
                       Save Wallet
                    </button>
                </form>
              </div>
            </div>
          );
        };


        // --- Main App Component ---

        function App() {
          const [activeTab, setActiveTab] = useState('home');
          
          // Define default cycle day constant
          const DEFAULT_CYCLE_DAY = 25;
          const [salaryDate, setSalaryDate] = useState(DEFAULT_CYCLE_DAY);
          
          // Logic to determine the default view month based on cycle
          const [currentDate, setCurrentDate] = useState(() => {
            const now = new Date();
            // Initial check using default
            if (now.getDate() >= DEFAULT_CYCLE_DAY) {
                return new Date(now.getFullYear(), now.getMonth() + 1, 1);
            }
            return now;
          });
          
          // Effect to update Current View when Cycle Date changes
          useEffect(() => {
            const now = new Date();
            // Re-evaluate the "Current View" relative to today whenever the cycle date changes
            if (now.getDate() >= salaryDate) {
                // If today is past the start date, we are in the 'next' billing month
                setCurrentDate(new Date(now.getFullYear(), now.getMonth() + 1, 1));
            } else {
                // If today is before the start date, we are still in the 'current' calendar month's cycle
                setCurrentDate(new Date(now.getFullYear(), now.getMonth(), 1));
            }
          }, [salaryDate]);
          
          const [isDarkMode, setIsDarkMode] = useState(false);
          const [userName, setUserName] = useState(() => localStorage.getItem('userName') || '');
          const [showWelcome, setShowWelcome] = useState(!localStorage.getItem('userName'));
          
          const [transactions, setTransactions] = useState(() => {
            try {
              const saved = localStorage.getItem('transactions');
              return saved ? JSON.parse(saved) : initialTransactionsData;
            } catch { return initialTransactionsData; }
          });
          
          const [loans, setLoans] = useState(() => {
            try {
              const saved = localStorage.getItem('loans');
              return saved ? JSON.parse(saved) : initialLoansData;
            } catch { return initialLoansData; }
          });
          
          const [goals, setGoals] = useState(() => {
            try {
              const saved = localStorage.getItem('goals');
              return saved ? JSON.parse(saved) : initialGoalsData;
            } catch { return initialGoalsData; }
          });

          const [subs, setSubs] = useState(() => {
            try {
              const saved = localStorage.getItem('subs');
              return saved ? JSON.parse(saved) : initialSubsData;
            } catch { return initialSubsData; }
          });

          const [wallets, setWallets] = useState(getInitialWallets);

          const [isTransactionModalOpen, setIsTransactionModalOpen] = useState(false);
          const [isLoanModalOpen, setIsLoanModalOpen] = useState(false);
          const [isSubModalOpen, setIsSubModalOpen] = useState(false);
          const [isAddGoalModalOpen, setIsAddGoalModalOpen] = useState(false);
          
          const [editingTransaction, setEditingTransaction] = useState(null);
          const [editingLoan, setEditingLoan] = useState(null);
          const [editingSub, setEditingSub] = useState(null);
          const [editingGoal, setEditingGoal] = useState(null);

          const [isWalletModalOpen, setIsWalletModalOpen] = useState(false);
          const [selectedWallet, setSelectedWallet] = useState(null);

          const [isSearchOpen, setIsSearchOpen] = useState(false);
          const [searchQuery, setSearchQuery] = useState('');
          const [geminiData, setGeminiData] = useState(null);
          const [loadingGemini, setLoadingGemini] = useState(false);
          
          const [isNotifOpen, setIsNotifOpen] = useState(false);
          const [notifications, setNotifications] = useState([]);
          const [resetTargetMonth, setResetTargetMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

          // UI State for Modals/Toasts
          const [confirmModalConfig, setConfirmModalConfig] = useState({ isOpen: false, title: '', message: '', onConfirm: () => {} });
          const [toastConfig, setToastConfig] = useState({ message: '', type: 'success' });

          const showToast = useCallback((message, type = 'success') => {
              setToastConfig({ message, type });
          }, []);
          
          const closeToast = () => {
              setToastConfig({ ...toastConfig, message: '' });
          };

          const handleManageWallets = useCallback(() => {
              setActiveTab('wallet');
              setIsTransactionModalOpen(false);
              showToast("Click on a card to add/edit details", "info");
          }, [showToast]);
          
          const handleNameSave = (name) => {
              setUserName(name);
              localStorage.setItem('userName', name);
              setShowWelcome(false);
          };

          // Notification Logic
          useEffect(() => {
            const newNotifs = [];
            const today = new Date();
            today.setHours(0,0,0,0);

            // Check Subs
            subs.forEach(sub => {
              const daysLeft = getDaysUntil(sub.nextDate);
              if (daysLeft <= 3 && daysLeft >= 0) {
                newNotifs.push({ type: 'info', title: 'Subscription Due', message: `${sub.name} is due in ${daysLeft === 0 ? 'today' : daysLeft + ' days'}`});
              }
            });

            // Check Loans
            loans.forEach(loan => {
              const daysLeft = getDaysUntil(loan.dueDate);
              if (daysLeft <= 3 && daysLeft >= 0) {
                newNotifs.push({ type: 'alert', title: 'Loan Due', message: `Loan with ${loan.person} is due soon.`});
              }
            });
            
            setNotifications(newNotifs);
          }, [subs, loans]);

          useEffect(() => { localStorage.setItem('transactions', JSON.stringify(transactions)); }, [transactions]);
          useEffect(() => { localStorage.setItem('loans', JSON.stringify(loans)); }, [loans]);
          useEffect(() => { localStorage.setItem('goals', JSON.stringify(goals)); }, [goals]);
          useEffect(() => { localStorage.setItem('subs', JSON.stringify(subs)); }, [subs]);
          useEffect(() => { localStorage.setItem('wallets', JSON.stringify(wallets)); }, [wallets]);

          // --- Cycle Calculation Logic ---
          const { start: cycleStart, end: cycleEnd } = useMemo(() => {
            return getCycleRange(currentDate, salaryDate);
          }, [currentDate, salaryDate]);

          // --- Filtering by Date Cycle & Search ---
          const dateFilteredTransactions = useMemo(() => {
            return transactions.filter(t => {
              const txDate = parseDate(t.date);
              // Ensure time comparison is fair
              const start = new Date(cycleStart); start.setHours(0,0,0,0);
              const end = new Date(cycleEnd); end.setHours(23,59,59,999);
              const tx = new Date(txDate); tx.setHours(12,0,0,0); // set to mid-day to avoid TZ issues
              return tx >= start && tx <= end;
            });
          }, [transactions, cycleStart, cycleEnd]);

          // Memoized Calculations based on DATE FILTERED data
          const { totalBalance, totalIncome, totalExpense } = useMemo(() => {
            // Calculate totals for the *current view* (month)
            const cycleTotals = dateFilteredTransactions.reduce((acc, curr) => {
              // Transfers are internal, don't count towards income/expense totals unless tracking externally
              if (curr.type === 'transfer') return acc;

              if (curr.amount > 0) acc.totalIncome += curr.amount;
              else acc.totalExpense += curr.amount;
              return acc;
            }, { totalIncome: 0, totalExpense: 0 });

            const allTimeBalance = transactions.reduce((acc, curr) => {
                if (curr.type === 'transfer') return acc; // Transfers don't change total net worth
                return acc + curr.amount;
            }, 0);

            return { totalBalance: allTimeBalance, ...cycleTotals }; 
          }, [transactions, dateFilteredTransactions]);

          const { totalGiven, totalTaken } = useMemo(() => {
            return loans.reduce((acc, l) => {
              if (l.type === 'given') acc.totalGiven += l.amount;
              else acc.totalTaken += l.amount;
              return acc;
            }, { totalGiven: 0, totalTaken: 0 });
          }, [loans]);

          const { totalGoalTarget, totalGoalSaved } = useMemo(() => {
            return goals.reduce((acc, g) => {
              acc.totalGoalTarget += g.target;
              acc.totalGoalSaved += g.saved;
              return acc;
            }, { totalGoalTarget: 0, totalGoalSaved: 0 });
          }, [goals]);

          // Wallet Balances (Dynamic calculation)
          const walletBalances = useMemo(() => {
            const calculated = {};
            // Initialize with 0
            wallets.forEach(w => calculated[w.id] = 0);
            
            transactions.forEach(t => {
              const amount = Math.abs(t.amount); 
              
              // Handle source (if exists)
              if (calculated[t.account] !== undefined) {
                 if (t.type === 'transfer') {
                     calculated[t.account] -= amount;
                 } else {
                     // Regular income/expense (amount is signed)
                     calculated[t.account] += t.amount;
                 }
              }

              // Handle destination (transfer)
              if (t.type === 'transfer' && calculated[t.toAccount] !== undefined) {
                  calculated[t.toAccount] += amount;
              }
            });
            return calculated;
          }, [transactions, wallets]);

          // Callbacks
          const changeMonth = useCallback((direction) => {
            setCurrentDate(prev => {
              const newDate = new Date(prev);
              newDate.setMonth(prev.getMonth() + direction);
              return newDate;
            });
          }, []);

          const handleWalletClick = (wallet) => {
              setSelectedWallet(wallet);
              setIsWalletModalOpen(true);
          };

          const handleSaveWallet = (walletData) => {
              setWallets(prev => {
                  const index = prev.findIndex(w => w.id === walletData.id);
                  if (index >= 0) {
                      const newWallets = [...prev];
                      newWallets[index] = walletData;
                      return newWallets;
                  }
                  return [...prev, walletData];
              });
          };

          const handleSaveTransaction = useCallback((data) => {
            setTransactions(prev => {
              const existing = prev.findIndex(t => t.id === data.id);
              
              let iconKey = 'Wallet';
              if (data.type === 'transfer') {
                  iconKey = 'ArrowRightLeft';
              } else if (data.type === 'expense') {
                  iconKey = getCategoryIcon(data.category);
              }

              const processedTransaction = {
                ...data,
                amount: data.type === 'expense' ? -Math.abs(data.amount) : Math.abs(data.amount),
                icon: iconKey, 
                color: data.type === 'transfer' ? theme.royalBlue : (data.type === 'expense' ? theme.hotPink : theme.teal),
              };
              
              if (existing >= 0) {
                const updated = [...prev];
                updated[existing] = { ...updated[existing], ...processedTransaction };
                return updated;
              }
              return [processedTransaction, ...prev];
            });

            const txDate = parseDate(data.date);
            const { start, end } = getCycleRange(currentDate, salaryDate);
            const txTime = txDate.getTime();
            const startTime = start.setHours(0,0,0,0);
            const endTime = end.setHours(23,59,59,999);

            if (txTime < startTime || txTime > endTime) {
                 setCurrentDate(txDate);
                 showToast(`Jumped to ${formatDisplayDate(data.date)}`);
            } else {
                 showToast('Transaction saved!');
            }
          }, [currentDate, salaryDate, showToast]);

          const handleDeleteTransaction = useCallback((id) => {
            setTransactions(prev => prev.filter(t => t.id !== id));
            showToast('Transaction deleted', 'success');
          }, [showToast]);

          const handleSaveLoan = useCallback((data) => {
            setLoans(prev => {
              const existing = prev.findIndex(l => l.id === data.id);
              if (existing >= 0) {
                const updated = [...prev];
                updated[existing] = data;
                return updated;
              }
              return [data, ...prev];
            });
            showToast('Loan saved!');
          }, [showToast]);

          const handleDeleteLoan = useCallback((id) => {
            setLoans(prev => prev.filter(l => l.id !== id));
            showToast('Loan deleted');
          }, [showToast]);

          const handleSaveSub = useCallback((data) => {
            setSubs(prev => {
              const existing = prev.findIndex(s => s.id === data.id);
              if (existing >= 0) {
                const updated = [...prev];
                updated[existing] = data;
                return updated;
              }
              return [data, ...prev];
            });
            showToast('Subscription saved!');
          }, [showToast]);

          const handleDeleteSub = useCallback((id) => {
            setSubs(prev => prev.filter(s => s.id !== id));
            showToast('Subscription removed');
          }, [showToast]);

          const handleSaveGoal = useCallback((data) => {
            setGoals(prev => {
               const existing = prev.findIndex(g => g.id === data.id);
               if (existing >= 0) {
                 const updated = [...prev];
                 updated[existing] = data;
                 return updated;
               }
               return [data, ...prev];
            });
            showToast('Goal saved!');
          }, [showToast]);

          const handleDeleteGoal = useCallback((id) => {
            setGoals(prev => prev.filter(g => g.id !== id));
            showToast('Goal removed');
          }, [showToast]);
          
          const handleResetSpecificMonth = useCallback(() => {
            if (!resetTargetMonth) return;
            
            setConfirmModalConfig({
                isOpen: true,
                title: 'Reset Month Data',
                message: `Are you sure you want to delete transactions for ${resetTargetMonth}?`,
                onConfirm: () => {
                    const [year, month] = resetTargetMonth.split('-').map(Number);
                    const targetDate = new Date(year, month - 1, 1);
                    const { start, end } = getCycleRange(targetDate, salaryDate);

                    setTransactions(prev => prev.filter(t => {
                        const txDate = parseDate(t.date);
                        const txTime = new Date(txDate).setHours(0,0,0,0);
                        const sTime = start.setHours(0,0,0,0);
                        const eTime = end.setHours(23,59,59,999);
                        
                        return !(txTime >= sTime && txTime <= eTime);
                    }));
                    showToast('Month data reset successfully');
                }
            });
          }, [resetTargetMonth, salaryDate, showToast]);

          const handleResetAll = useCallback(() => {
            setConfirmModalConfig({
                isOpen: true,
                title: 'Reset All Data',
                message: "Are you sure you want to reset ALL data? This cannot be undone.",
                onConfirm: () => {
                    setTransactions([]);
                    setLoans([]);
                    setGoals([]);
                    setSubs([]);
                    showToast('All data cleared', 'success');
                }
            });
          }, [showToast]);

          const filteredTransactions = useMemo(() => {
            const source = dateFilteredTransactions;
            if (!searchQuery) return source;
            const lowerQuery = searchQuery.toLowerCase();
            return source.filter(t => 
              t.title.toLowerCase().includes(lowerQuery) ||
              t.category.toLowerCase().includes(lowerQuery) ||
              (t.note && t.note.toLowerCase().includes(lowerQuery))
            );
          }, [dateFilteredTransactions, searchQuery]);

          const filteredLoans = useMemo(() => {
            if (!searchQuery) return loans;
            return loans.filter(l => l.person.toLowerCase().includes(searchQuery.toLowerCase()));
          }, [loans, searchQuery]);

          const filteredGoals = useMemo(() => {
            if (!searchQuery) return goals;
            return goals.filter(g => g.title.toLowerCase().includes(searchQuery.toLowerCase()));
          }, [goals, searchQuery]);

          const filteredSubs = useMemo(() => {
            if (!searchQuery) return subs;
            return subs.filter(s => s.name.toLowerCase().includes(searchQuery.toLowerCase()));
          }, [subs, searchQuery]);

          const groupedTransactions = useMemo(() => {
            const sorted = [...filteredTransactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return sorted.reduce((groups, t) => {
              const date = t.date;
              if (!groups[date]) groups[date] = [];
              groups[date].push(t);
              return groups;
            }, {});
          }, [filteredTransactions]);

          // --- FIXED CHART COLORS: Vibrant Palette for Donut ---
          const currentStatsData = useMemo(() => {
            const expenseTx = dateFilteredTransactions.filter(t => t.type === 'expense');
            const catSpending = expenseTx.reduce((acc, t) => {
                const cat = t.category;
                acc[cat] = (acc[cat] || 0) + Math.abs(t.amount);
                return acc;
            }, {});
            
            // Vibrant colors specifically chosen to be suitable and not dark
            const vibrantPalette = [
              theme.royalBlue, theme.skyBlue, theme.teal, theme.mint, 
              theme.purple, theme.hotPink, theme.amber, theme.salmon
            ];

            const data = Object.entries(catSpending).map(([label, value], index) => ({
                label,
                value,
                color: vibrantPalette[index % vibrantPalette.length]
            }));
            
            data.sort((a, b) => b.value - a.value);

            return data.length > 0 ? data : [{ label: 'No Data', value: 1, color: isDarkMode ? '#374151' : '#e5e7eb' }];
          }, [dateFilteredTransactions, isDarkMode]);
          
          // --- FIXED CHART COLORS: COLORFUL GRADIENTS for Bar Chart ---
          const last7DaysChartData = useMemo(() => {
            const data = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
              const d = new Date(today);
              d.setDate(d.getDate() - i);
              const isoDate = formatDateToISO(d);
              const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
              
              const dayTotal = transactions
                .filter(t => t.date === isoDate && t.type === 'expense') 
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                
              data.push({
                day: dayName,
                value: dayTotal,
                // Color property is effectively ignored by the BarChart component now in favor of gradients array
                color: theme.royalBlue 
              });
            }
            return data;
          }, [transactions]);

          const insights = useMemo(() => {
            const expenseTx = dateFilteredTransactions.filter(t => t.type === 'expense');
            const catSpending = expenseTx.reduce((acc, t) => {
              acc[t.category] = (acc[t.category] || 0) + Math.abs(t.amount);
              return acc;
            }, {});

            let maxCat = 'None';
            let maxVal = 0;
            Object.entries(catSpending).forEach(([cat, val]) => {
              if (val > maxVal) {
                maxVal = val;
                maxCat = cat;
              }
            });

            return {
              maxCat,
              maxVal,
              potentialSavings: maxVal * 0.15,
              projectedBalance: totalBalance + (maxVal * 0.15)
            };
          }, [dateFilteredTransactions, totalBalance]);

          const fetchGeminiAdvice = useCallback(async () => {
            setLoadingGemini(true);
            setGeminiData(null);
            const transactionSummary = transactions.slice(0, 10).map(t => ({ title: t.title, amount: t.amount, category: t.category, date: t.date }));
            const prompt = `Analyze: ${JSON.stringify(transactionSummary)}. Return JSON: { "analysis": "Brief analysis", "actionable_tip": "Specific tip", "potential_savings": number }`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
              const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } }) });
              if (!response.ok) throw new Error('API failed');
              const data = await response.json();
              setGeminiData(JSON.parse(data.candidates[0].content.parts[0].text));
            } catch (error) {
              setGeminiData({ analysis: "Couldn't connect to AI.", actionable_tip: "Try cooking at home more often.", potential_savings: 50 });
            } finally { setLoadingGemini(false); }
          }, [transactions]);

          const renderContent = () => {
            const cardBgClass = isDarkMode ? 'bg-gray-800' : 'bg-white';
            const textColor = isDarkMode ? 'text-white' : '';
            const textStyle = isDarkMode ? {} : { color: theme.navy };
            
            const totalAssets = Object.values(walletBalances).reduce((a, b) => a + b, 0);

            switch (activeTab) {
              case 'home':
                return (
                  <div key="home" className="animate-page-enter">
                    <MonthSelector date={currentDate} salaryDate={salaryDate} onPrev={() => changeMonth(-1)} onNext={() => changeMonth(1)} isDarkMode={isDarkMode} />
                    <BalanceCard totalBalance={totalBalance} income={totalIncome} expense={totalExpense} isDarkMode={isDarkMode} />
                    <QuickActions isDarkMode={isDarkMode} onNavigate={setActiveTab} />
                    {/* Increased mobile padding to pb-40 */}
                    <div className={`${cardBgClass} rounded-t-[2.5rem] mt-2 px-6 pt-8 pb-40 md:pb-8 min-h-screen shadow-[0_-10px_40px_rgba(0,0,0,0.02)] animate-slide-up-fade transition-colors duration-300 relative`} style={{ animationDelay: '0.2s' }}>
                      <div className="flex justify-between items-center mb-6">
                        <h3 className={`font-bold text-lg tracking-tight ${textColor}`} style={textStyle}>Recent Activity</h3>
                      </div>
                      <div className="flex flex-col gap-6">
                        {Object.keys(groupedTransactions).length > 0 ? (
                          Object.entries(groupedTransactions).map(([dateLabel, items], groupIndex) => (
                            <div key={dateLabel} className="animate-stagger-in" style={{ animationDelay: `${groupIndex * 0.1}s` }}>
                              <h4 className={`text-xs font-bold uppercase tracking-widest mb-3 ml-1 opacity-60 ${isDarkMode ? 'text-gray-500' : 'text-gray-400'}`}>{formatDisplayDate(dateLabel) || dateLabel}</h4>
                              <div className="flex flex-col gap-1">
                                {items.map((t, idx) => (
                                  <TransactionItem 
                                    key={t.id} 
                                    item={t} 
                                    index={idx} 
                                    isDarkMode={isDarkMode} 
                                    wallets={wallets}
                                    onClick={(item) => { setEditingTransaction(item); setIsTransactionModalOpen(true); }}
                                  />
                                ))}
                              </div>
                            </div>
                          ))
                        ) : (<p className="text-center text-gray-400 py-8 text-sm">No transactions found for this period.</p>)}
                      </div>
                    </div>
                  </div>
                );
                case 'wallet': return (
                    <div key="wallet" className="px-6 pb-40 md:pb-8 animate-page-enter mt-4">
                        <div className={`p-6 rounded-[2rem] shadow-sm mb-6 ${isDarkMode ? 'bg-gray-800' : 'bg-white'}`}>
                            <span className="text-xs font-bold uppercase tracking-widest opacity-60 block mb-1">Total Assets</span>
                            <h3 className={`text-3xl font-bold ${textColor}`} style={textStyle}>${totalAssets.toLocaleString()}</h3>
                        </div>

                        <div className="flex flex-col gap-4 mb-6">
                            {wallets.map((wallet, idx) => (
                                <WalletCard 
                                    key={wallet.id}
                                    wallet={{...wallet, balance: walletBalances[wallet.id]}}
                                    isDarkMode={isDarkMode}
                                    onClick={() => handleWalletClick(wallet)}
                                />
                            ))}
                        </div>

                        <button 
                            onClick={() => { setSelectedWallet(null); setIsWalletModalOpen(true); }}
                            className={`w-full py-4 rounded-2xl border-2 border-dashed flex items-center justify-center gap-2 transition-all ${isDarkMode ? 'border-gray-700 text-gray-400 hover:border-gray-500 hover:text-gray-300' : 'border-gray-200 text-gray-500 hover:border-gray-300 hover:text-gray-600'}`}
                        >
                            <PlusCircle size={20} />
                            <span className="font-bold text-sm">Add New Wallet</span>
                        </button>
                    </div>
                );
                case 'loans': return (
                    <div key="loans" className="px-6 pb-40 md:pb-8 animate-page-enter mt-4">
                      <div className="flex gap-4 mb-8">
                        <div className={`flex-1 p-5 rounded-[1.5rem] shadow-sm ${isDarkMode ? 'bg-red-500/10' : 'bg-red-50'}`}>
                          <div className="flex items-center gap-2 mb-2 opacity-80"><ArrowDownLeft size={16} className="text-red-500" /><span className={`text-xs font-bold uppercase tracking-widest ${isDarkMode ? 'text-red-400' : 'text-red-600'}`}>Borrowed</span></div>
                          <h3 className={`text-2xl font-bold ${isDarkMode ? 'text-red-400' : 'text-red-600'}`}>${totalTaken.toLocaleString()}</h3>
                        </div>
                        <div className={`flex-1 p-5 rounded-[1.5rem] shadow-sm ${isDarkMode ? 'bg-teal-500/10' : 'bg-teal-50'}`}>
                          <div className="flex items-center gap-2 mb-2 opacity-80"><ArrowUpRight size={16} className="text-teal-500" /><span className={`text-xs font-bold uppercase tracking-widest ${isDarkMode ? 'text-teal-400' : 'text-teal-700'}`}>Lent</span></div>
                          <h3 className={`text-2xl font-bold ${isDarkMode ? 'text-teal-400' : 'text-teal-700'}`}>${totalGiven.toLocaleString()}</h3>
                        </div>
                      </div>
                      <div className={`${cardBgClass} p-6 rounded-[2rem] shadow-sm animate-slide-up-fade transition-colors duration-300`}>
                        <div className="flex justify-between items-center mb-6"><h3 className={`font-bold text-lg tracking-tight ${textColor}`} style={textStyle}>Active Loans</h3><span className="text-xs font-bold text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded-full">{filteredLoans.length}</span></div>
                        <div className="flex flex-col gap-1">{filteredLoans.length > 0 ? (filteredLoans.map((loan, idx) => (<LoanItem key={loan.id} item={loan} index={idx} isDarkMode={isDarkMode} onClick={(item) => { setEditingLoan(item); setIsLoanModalOpen(true); }} />))) : (<p className="text-center text-gray-400 py-8 text-sm">No active loans found.</p>)}</div>
                      </div>
                      <button 
                          onClick={() => { setEditingLoan(null); setIsLoanModalOpen(true); }}
                          className={`w-full py-4 mt-6 rounded-2xl border-2 border-dashed flex items-center justify-center gap-2 transition-all ${isDarkMode ? 'border-gray-700 text-gray-400 hover:border-gray-500 hover:text-gray-300' : 'border-gray-200 text-gray-500 hover:border-gray-300 hover:text-gray-600'}`}
                      >
                          <PlusCircle size={20} />
                          <span className="font-bold text-sm">Add New Loan</span>
                      </button>
                    </div>
                );
                case 'goals': return (
                    <div key="goals" className="px-6 pb-40 md:pb-8 animate-page-enter mt-4">
                      <div className={`p-6 rounded-[2rem] shadow-lg mb-8 relative overflow-hidden ${isDarkMode ? 'bg-gray-800' : 'bg-[#052065]'}`}><div className="relative z-10 flex justify-between items-end"><div className="text-white"><span className="text-xs font-bold uppercase tracking-widest opacity-70 mb-1 block">Total Saved</span><h3 className="text-3xl font-bold">${totalGoalSaved.toLocaleString()}</h3><p className="text-xs opacity-60 mt-1">Target: ${totalGoalTarget.toLocaleString()}</p></div><div className="w-16 h-16 rounded-full border-4 border-teal-400 flex items-center justify-center text-white font-bold">{totalGoalTarget > 0 ? Math.round((totalGoalSaved / totalGoalTarget) * 100) : 0}%</div></div><div className="absolute -right-6 -bottom-10 opacity-10"><Trophy size={120} color="white" /></div></div>
                      <div><div className="flex justify-between items-center mb-4"><h3 className={`font-bold text-lg tracking-tight ${textColor}`} style={textStyle}>Your Targets</h3></div><div className="flex flex-col gap-1">{filteredGoals.length > 0 ? (filteredGoals.map((goal, idx) => (<GoalItem key={goal.id} item={goal} index={idx} isDarkMode={isDarkMode} onClick={(item) => { setEditingGoal(item); setIsAddGoalModalOpen(true); }} />))) : (<p className="text-center text-gray-400 py-8 text-sm">No goals set yet.</p>)}</div></div>
                      <button 
                          onClick={() => { setEditingGoal(null); setIsAddGoalModalOpen(true); }}
                          className={`w-full py-4 mt-6 rounded-2xl border-2 border-dashed flex items-center justify-center gap-2 transition-all ${isDarkMode ? 'border-gray-700 text-gray-400 hover:border-gray-500 hover:text-gray-300' : 'border-gray-200 text-gray-500 hover:border-gray-300 hover:text-gray-600'}`}
                      >
                          <PlusCircle size={20} />
                          <span className="font-bold text-sm">Create New Goal</span>
                      </button>
                    </div>
                );
                case 'subs': return (
                    <div key="subs" className="px-6 pb-40 md:pb-8 animate-page-enter mt-4">
                      <div className={`${cardBgClass} p-6 rounded-[2rem] shadow-sm animate-slide-up-fade transition-colors duration-300`}>
                        <div className="flex justify-between items-center mb-6"><h3 className={`font-bold text-lg tracking-tight ${textColor}`} style={textStyle}>Active Subs</h3><span className="text-xs font-bold text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded-full">{filteredSubs.length}</span></div><div className="flex flex-col gap-1">{filteredSubs.length > 0 ? (filteredSubs.map((sub, idx) => (<SubItem key={sub.id} item={sub} index={idx} isDarkMode={isDarkMode} onClick={(item) => { setEditingSub(item); setIsSubModalOpen(true); }} />))) : (<p className="text-center text-gray-400 py-8 text-sm">No subscriptions added.</p>)}</div>
                      </div>
                      <button 
                          onClick={() => { setEditingSub(null); setIsSubModalOpen(true); }}
                          className={`w-full py-4 mt-6 rounded-2xl border-2 border-dashed flex items-center justify-center gap-2 transition-all ${isDarkMode ? 'border-gray-700 text-gray-400 hover:border-gray-500 hover:text-gray-300' : 'border-gray-200 text-gray-500 hover:border-gray-300 hover:text-gray-600'}`}
                      >
                          <PlusCircle size={20} />
                          <span className="font-bold text-sm">Add Subscription</span>
                      </button>
                    </div>
                );
                case 'stats': return (
                    // Added responsive pb-40 for mobile, md:pb-8 for desktop
                    <div key="stats" className="pb-40 md:pb-8 animate-page-enter mt-4"><div className="pt-2"><MonthSelector date={currentDate} salaryDate={salaryDate} onPrev={() => changeMonth(-1)} onNext={() => changeMonth(1)} isDarkMode={isDarkMode} /></div><div className="px-6"><div className={`${cardBgClass} p-6 rounded-[2rem] shadow-sm mb-6 animate-scale-in transition-colors duration-300`} style={{ animationDelay: '0.1s' }}><h3 className={`font-bold mb-4 ${textColor}`} style={textStyle}>Expense Breakdown</h3><DonutChart data={currentStatsData} isDarkMode={isDarkMode} />
                          <div className="grid grid-cols-1 gap-y-3 mt-6"> 
                            {currentStatsData.map((d, i) => (
                              <div key={i} className="group relative overflow-hidden rounded-xl bg-gray-50 dark:bg-gray-800/40 border border-gray-100 dark:border-gray-700/50 p-3 hover:border-gray-200 dark:hover:border-gray-600 transition-all cursor-pointer">
                                  <div className="absolute bottom-0 left-0 h-1 bg-current opacity-20 transition-all duration-1000 ease-out" style={{ width: `${(d.value / currentStatsData.reduce((acc, curr) => acc + curr.value, 0)) * 100}%`, color: d.color }} />
                                  <div className="flex items-center justify-between relative z-10"><div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full flex items-center justify-center bg-white dark:bg-gray-700 shadow-sm text-xs font-bold" style={{ color: d.color }}>{d.label.charAt(0)}</div><span className={`text-sm font-semibold tracking-tight ${isDarkMode ? 'text-gray-200' : 'text-gray-700'}`}>{d.label}</span></div><div className="flex items-center gap-3"><span className={`text-sm font-bold tabular-nums ${textColor}`} style={textStyle}>{d.value === 1 && d.label === 'No Data' ? '-' : `$${d.value.toLocaleString()}`}</span><span className="text-[10px] font-bold px-2 py-1 rounded-md bg-white dark:bg-gray-700 shadow-sm text-gray-500 min-w-[45px] text-center">{d.value === 1 && d.label === 'No Data' ? '0%' : `${Math.round((d.value / currentStatsData.reduce((acc, curr) => acc + curr.value, 0)) * 100)}%`}</span></div></div></div>))}</div></div><div className={`${cardBgClass} p-6 rounded-[2rem] shadow-sm animate-scale-in transition-colors duration-300`} style={{ animationDelay: '0.2s' }}><h3 className={`font-bold mb-8 ${textColor}`} style={textStyle}>Weekly Spending</h3><BarChart data={last7DaysChartData} isDarkMode={isDarkMode} /></div></div></div>
                );
              case 'suggestions':
                return (
                  <div key="suggestions" className="px-6 pb-40 md:pb-8 animate-page-enter mt-4">
                    <div className="flex items-center justify-end mt-4 mb-6">
                        <button onClick={fetchGeminiAdvice} disabled={loadingGemini} className="flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 text-white text-xs font-bold shadow-md hover:shadow-lg transition-all active:scale-95 disabled:opacity-50">{loadingGemini ? <Loader2 size={14} className="animate-spin" /> : <Sparkles size={14} />}{loadingGemini ? 'Analyzing...' : 'Ask AI'}</button>
                    </div>
                    {geminiData && (<div className="p-6 rounded-[2rem] shadow-lg mb-6 bg-gradient-to-br from-indigo-600 to-purple-700 text-white animate-scale-in relative overflow-hidden"><div className="relative z-10"><div className="flex items-center gap-2 mb-3"><div className="p-1.5 bg-white/20 rounded-lg backdrop-blur-sm"><Sparkles size={16} className="text-yellow-300" /></div><span className="text-xs font-bold uppercase tracking-widest opacity-90">Gemini Advisor</span></div><h3 className="text-xl font-bold mb-2 leading-tight">{geminiData.analysis}</h3><div className="bg-black/20 rounded-xl p-4 mt-4 backdrop-blur-sm border border-white/10"><p className="text-sm font-medium mb-1 opacity-80 uppercase text-xs tracking-wider">Action Plan</p><p className="text-sm leading-relaxed">{geminiData.actionable_tip}</p></div><div className="mt-4 flex items-center gap-2"><span className="text-sm opacity-80">Potential Savings:</span><span className="text-xl font-bold text-green-300">${geminiData.potential_savings}</span></div></div><div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10"></div><div className="absolute bottom-0 left-0 w-24 h-24 bg-purple-500/30 rounded-full blur-2xl -ml-5 -mb-5"></div></div>)}
                    {!geminiData && (<div className={`p-6 rounded-[2rem] shadow-lg mb-6 relative overflow-hidden ${isDarkMode ? 'bg-gradient-to-br from-indigo-900 to-gray-900' : 'bg-gradient-to-br from-[#052065] to-[#0060E5]'}`}><div className="relative z-10 text-white"><div className="flex items-center gap-2 mb-2 opacity-80"><Target size={18} className="text-yellow-300" /><span className="text-xs font-bold uppercase tracking-widest">Monthly Goal</span></div><h3 className="text-2xl font-bold mb-1">Save ${Math.floor(insights.potentialSavings)} more</h3><p className="opacity-80 text-sm mb-6">Based on your current spending patterns.</p><div className="flex gap-4"><div className="flex-1 bg-white/10 rounded-xl p-3 backdrop-blur-sm"><span className="text-[10px] font-bold uppercase opacity-70 block mb-1">Current</span><span className="text-lg font-bold">${totalBalance.toLocaleString()}</span></div><div className="flex-1 bg-white/20 rounded-xl p-3 backdrop-blur-sm border border-white/20"><span className="text-[10px] font-bold uppercase opacity-70 block mb-1 text-green-200">Potential</span><span className="text-lg font-bold text-green-300">${insights.projectedBalance.toLocaleString(undefined, {maximumFractionDigits: 0})}</span></div></div></div><div className="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div></div>)}
                    <div className={`${cardBgClass} p-6 rounded-[2rem] shadow-sm mb-6 animate-slide-up-fade transition-colors duration-300`} style={{ animationDelay: '0.1s' }}><div className="flex items-start gap-4"><div className={`p-3 rounded-2xl ${isDarkMode ? 'bg-red-500/20 text-red-400' : 'bg-red-50 text-red-500'}`}><TrendingDown size={24} /></div><div><h4 className={`font-bold text-lg mb-1 ${textColor}`} style={textStyle}>High Spending Alert</h4><p className="text-sm text-gray-500 leading-relaxed mb-3">You've spent <span className={`font-bold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>${insights.maxVal}</span> on <span className={`font-bold ${isDarkMode ? 'text-white' : 'text-gray-900'}`}>{insights.maxCat}</span> this month.
                          </p>
                          <div className={`p-3 rounded-xl border border-dashed ${isDarkMode ? 'border-gray-700 bg-gray-800/50' : 'border-gray-200 bg-gray-50'}`}>
                            <p className={`text-xs font-medium ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                              💡 <strong>Tip:</strong> Reducing this by just 15% could save you <strong>${Math.floor(insights.potentialSavings)}</strong>/mo.
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className={`${cardBgClass} p-6 rounded-[2rem] shadow-sm animate-slide-up-fade transition-colors duration-300`} style={{ animationDelay: '0.2s' }}><div className="flex items-center gap-3 mb-4"><div className={`p-2 rounded-xl ${isDarkMode ? 'bg-green-500/20 text-green-400' : 'bg-green-50 text-green-600'}`}><Target size={20} /></div><h4 className={`font-bold ${textColor}`} style={textStyle}>Budget Health</h4></div><div className="space-y-4"><div><div className="flex justify-between text-xs font-bold mb-2 opacity-70"><span className={isDarkMode ? 'text-gray-400' : 'text-gray-500'}>Necessities (50%)</span><span className={isDarkMode ? 'text-white' : 'text-gray-900'}>$1,240 / $2,000</span></div><div className={`h-2 w-full rounded-full ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}><div className="h-full bg-blue-500 rounded-full" style={{ width: '62%' }}></div></div></div><div><div className="flex justify-between text-xs font-bold mb-2 opacity-70"><span className={isDarkMode ? 'text-gray-400' : 'text-gray-500'}>Wants (30%)</span><span className={isDarkMode ? 'text-white' : 'text-gray-900'}>$850 / $1,200</span></div><div className={`h-2 w-full rounded-full ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}><div className="h-full bg-purple-500 rounded-full" style={{ width: '70%' }}></div></div></div><div><div className="flex justify-between text-xs font-bold mb-2 opacity-70"><span className={isDarkMode ? 'text-gray-400' : 'text-gray-500'}>Savings (20%)</span><span className={isDarkMode ? 'text-white' : 'text-gray-900'}>$300 / $800</span></div><div className={`h-2 w-full rounded-full ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}><div className="h-full bg-teal-500 rounded-full" style={{ width: '37%' }}></div></div></div></div></div>
                  </div>
                );
              case 'profile':
                return (
                  <div key="profile" className="px-6 pb-40 md:pb-8 animate-page-enter mt-6">
                    <div className={`${cardBgClass} p-6 rounded-[2rem] shadow-sm mb-6 animate-slide-up-fade transition-colors duration-300`}>
                      <div className={`flex items-center justify-between mb-8 pb-8 border-b ${isDarkMode ? 'border-gray-800' : 'border-gray-100'}`}>
                        <div className="flex items-center gap-4"><div className={`p-3 rounded-xl ${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>{isDarkMode ? <Moon size={20} className="text-gray-300" /> : <Sun size={20} className="text-indigo-600" />}</div><div><h3 className={`font-bold ${textColor}`} style={textStyle}>Dark Mode</h3><p className="text-xs text-gray-400 mt-1">Adjust screen brightness</p></div></div>
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className={`w-12 h-7 rounded-full p-1 transition-colors duration-300 flex items-center ${isDarkMode ? 'bg-gray-700 justify-end' : 'bg-gray-200 justify-start'}`}><div className="w-5 h-5 rounded-full bg-white shadow-sm" /></button>
                      </div>
                      <div className="flex items-center justify-between mb-6"><div><h3 className={`font-bold ${textColor}`} style={textStyle}>Cycle Start Date</h3><p className="text-sm text-gray-400 mt-1 font-medium">When does your month start?</p></div><div className={`w-12 h-12 rounded-xl flex items-center justify-center border ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}`}><span className="text-lg font-bold" style={{ color: theme.royalBlue }}>{salaryDate}</span></div></div>
                      <div className="mt-4"><input type="range" min="1" max="31" value={salaryDate} onChange={(e) => setSalaryDate(parseInt(e.target.value))} className="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" style={{ accentColor: theme.royalBlue }} /><div className="flex justify-between text-xs text-gray-400 mt-3 font-bold uppercase tracking-wider"><span>1st</span><span>15th</span><span>31st</span></div></div>
                      
                      {/* Divider */}
                      <div className={`my-8 border-b ${isDarkMode ? 'border-gray-800' : 'border-gray-100'}`}></div>

                      <h3 className={`font-bold mb-4 ${textColor}`} style={textStyle}>Data Management</h3>
                      
                      {/* Add Month Selector */}
                      <div className="mb-4">
                          <label className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Select Month to Reset</label>
                          <div className={`flex items-center px-4 py-3 rounded-xl border transition-all ${isDarkMode ? 'border-gray-700 bg-gray-800 text-white' : 'border-gray-200 bg-white text-gray-800'}`}>
                            <Calendar size={20} className="mr-3 opacity-50" />
                            <input 
                              type="month" 
                              value={resetTargetMonth} 
                              onChange={(e) => setResetTargetMonth(e.target.value)}
                              className={`bg-transparent w-full font-bold outline-none ${isDarkMode ? 'text-white' : 'text-gray-900'}`} 
                            />
                          </div>
                      </div>

                      <div className="flex flex-col gap-3">
                        <button 
                          onClick={handleResetSpecificMonth}
                          className="w-full py-3 rounded-xl border-2 border-red-100 text-red-500 font-bold text-sm hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center justify-center gap-2"
                        >
                          <Trash2 size={18} /> Delete Data for {resetTargetMonth}
                        </button>
                        <button 
                          onClick={handleResetAll}
                          className="w-full py-3 rounded-xl bg-red-500 text-white font-bold text-sm hover:bg-red-600 transition-colors flex items-center justify-center gap-2 shadow-md shadow-red-200"
                        >
                          <Trash2 size={18} /> Reset All Data
                        </button>
                      </div>
                    </div>
                  </div>
                );
              default:
                return (
                  <div key="other" className="flex flex-col items-center justify-center h-[60vh] text-gray-400 px-10 text-center animate-page-enter">
                    <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-6 ${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'}`}><Settings size={32} className="opacity-50" /></div>
                    <p className="font-medium text-sm">This section is under development.</p>
                  </div>
                );
            }
          };

          const mainBgClass = isDarkMode ? 'bg-gray-900' : 'bg-gray-50';

          return (
            <div className={`h-screen font-sans relative max-w-md mx-auto shadow-2xl overflow-hidden transition-colors duration-300 ${mainBgClass} flex flex-col`}>
              {showWelcome && <WelcomeModal onSave={handleNameSave} isDarkMode={isDarkMode} />}
              <div className="flex-1 overflow-y-auto custom-scrollbar scroll-smooth relative z-10" style={{ WebkitOverflowScrolling: 'touch' }}>
                  <Header isDarkMode={isDarkMode} setIsDarkMode={setIsDarkMode} isSearchOpen={isSearchOpen} setIsSearchOpen={setIsSearchOpen} searchQuery={searchQuery} setSearchQuery={setSearchQuery} notifications={notifications} isNotifOpen={isNotifOpen} setIsNotifOpen={setIsNotifOpen} activeTab={activeTab} userName={userName} />
                  {renderContent()}
              </div>
              {activeTab === 'home' && (
                <button onClick={() => { if (activeTab === 'loans') { setEditingLoan(null); setIsLoanModalOpen(true); } else if (activeTab === 'goals') { setEditingGoal(null); setIsAddGoalModalOpen(true); } else if (activeTab === 'subs') { setEditingSub(null); setIsSubModalOpen(true); } else { setEditingTransaction(null); setIsTransactionModalOpen(true); } }} className="fixed bottom-24 right-6 w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-white transition-all duration-300 hover:scale-105 active:scale-95 z-50 animate-bounce-in group" style={{ background: theme.hotPink }}><Plus size={28} className="group-hover:rotate-90 transition-transform duration-300" /></button>
              )}
              
              {/* Global Components */}
              <Toast message={toastConfig.message} type={toastConfig.type} onClose={closeToast} />
              <ConfirmationModal {...confirmModalConfig} onClose={() => setConfirmModalConfig({ ...confirmModalConfig, isOpen: false })} isDarkMode={isDarkMode} />
              
              {/* Modals */}
              <TransactionModal 
                isOpen={isTransactionModalOpen} 
                onClose={() => setIsTransactionModalOpen(false)} 
                onSave={handleSaveTransaction} 
                onDelete={handleDeleteTransaction} 
                initialData={editingTransaction} 
                isDarkMode={isDarkMode} 
                showToast={showToast} 
                wallets={wallets} 
                onManageWallets={handleManageWallets}
              />
              <LoanModal isOpen={isLoanModalOpen} onClose={() => setIsLoanModalOpen(false)} onSave={handleSaveLoan} onDelete={handleDeleteLoan} initialData={editingLoan} isDarkMode={isDarkMode} showToast={showToast} />
              <SubscriptionModal isOpen={isSubModalOpen} onClose={() => setIsSubModalOpen(false)} onSave={handleSaveSub} onDelete={handleDeleteSub} initialData={editingSub} isDarkMode={isDarkMode} showToast={showToast} />
              <AddGoalModal isOpen={isAddGoalModalOpen} onClose={() => setIsAddGoalModalOpen(false)} onSave={handleSaveGoal} onDelete={handleDeleteGoal} initialData={editingGoal} isDarkMode={isDarkMode} showToast={showToast} />
              <WalletDetailsModal isOpen={isWalletModalOpen} onClose={() => setIsWalletModalOpen(false)} onSave={handleSaveWallet} wallet={selectedWallet} isDarkMode={isDarkMode} showToast={showToast} isNew={!selectedWallet} />
              
              <div className={`fixed bottom-0 w-full max-w-md border-t px-6 py-4 pb-8 flex justify-between items-center z-40 transition-colors duration-300 ${isDarkMode ? 'bg-gray-900 border-gray-800' : 'bg-white border-gray-100'}`}>{['home', 'stats', 'wallet', 'suggestions', 'profile'].map((tab) => { const isActive = activeTab === tab; const Icons = { home: Home, stats: PieChart, wallet: Wallet, suggestions: Sparkles, profile: Settings }; const Icon = Icons[tab]; return (<button key={tab} onClick={() => setActiveTab(tab)} className={`flex flex-col items-center gap-1 transition-all duration-300 ${isActive ? 'scale-110' : 'text-gray-400 hover:text-gray-500 scale-100'}`} style={{ color: isActive ? theme.royalBlue : isDarkMode ? '#6b7280' : undefined }}><Icon size={24} strokeWidth={isActive ? 2.5 : 2} />{isActive && (<span className="w-1 h-1 rounded-full bg-current animate-fade-in mt-1"></span>)}</button>); })}</div>
              
              <NotificationSidebar 
                  notifications={notifications} 
                  isOpen={isNotifOpen} 
                  onClose={() => setIsNotifOpen(false)} 
                  isDarkMode={isDarkMode} 
              />
              
              <style>{` .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; } :root { --ease-ios: cubic-bezier(0.16, 1, 0.3, 1); } @keyframes pageEnter { from { opacity: 0; transform: scale(0.99) translateY(5px); } to { opacity: 1; transform: scale(1) translateY(0); } } @keyframes slideUpFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } @keyframes staggerIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } } @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } } @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } } @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } } .animate-fade-in { animation: fade-in 0.3s ease-out forwards; } .animate-page-enter { animation: pageEnter 0.4s var(--ease-ios) forwards; } .animate-slide-up-fade { animation: slideUpFade 0.5s var(--ease-ios) backwards; } .animate-stagger-in { animation: staggerIn 0.3s var(--ease-ios) forwards; } .animate-scale-in { animation: scaleIn 0.4s var(--ease-ios) backwards; } .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) backwards; } `}</style>
            </div>
          );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
